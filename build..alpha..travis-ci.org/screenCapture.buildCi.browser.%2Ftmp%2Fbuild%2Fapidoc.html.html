<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="http://apnagent.qualiancy.com">apnagent (v1.1.3)</a>
</h1>
<h4>Node adapter for Apple Push Notification (APN) service.</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent">module apnagent</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent">
            function <span class="apidocSignatureSpan">apnagent.</span>Agent
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super">
            function <span class="apidocSignatureSpan">apnagent.</span>Agent._super
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Device">
            function <span class="apidocSignatureSpan">apnagent.</span>Device
            <span class="apidocSignatureSpan">(token)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback">
            function <span class="apidocSignatureSpan">apnagent.</span>Feedback
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super">
            function <span class="apidocSignatureSpan">apnagent.</span>Feedback._super
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockAgent">
            function <span class="apidocSignatureSpan">apnagent.</span>MockAgent
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockFeedback">
            function <span class="apidocSignatureSpan">apnagent.</span>MockFeedback
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache">
            function <span class="apidocSignatureSpan">apnagent.</span>cache
            <span class="apidocSignatureSpan">(ttl)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError">
            function <span class="apidocSignatureSpan">apnagent.</span>errors.FeedbackAuthorizationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayAuthorizationError">
            function <span class="apidocSignatureSpan">apnagent.</span>errors.GatewayAuthorizationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayMessageError">
            function <span class="apidocSignatureSpan">apnagent.</span>errors.GatewayMessageError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.MessageSerializationError">
            function <span class="apidocSignatureSpan">apnagent.</span>errors.MessageSerializationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message">
            function <span class="apidocSignatureSpan">apnagent.</span>message
            <span class="apidocSignatureSpan">(agent, codec, opts)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan"></span>apnagent</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>Agent._super._super.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>Agent._super.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>Agent.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>Device.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>Feedback._super.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>Feedback.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>MockAgent.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>MockFeedback.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>cache.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>errors</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>errors.FeedbackAuthorizationError.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>errors.GatewayAuthorizationError.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>errors.GatewayMessageError.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>errors.MessageSerializationError.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>index</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>message.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.</span>util</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">apnagent.</span>version</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Agent">module apnagent.Agent</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent.Agent">
            function <span class="apidocSignatureSpan">apnagent.</span>Agent
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super">
            function <span class="apidocSignatureSpan">apnagent.Agent.</span>_super
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Agent._super">module apnagent.Agent._super</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super">
            function <span class="apidocSignatureSpan">apnagent.Agent.</span>_super
            <span class="apidocSignatureSpan">(opts)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Agent._super._super.prototype">module apnagent.Agent._super._super.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.addListener">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>addListener
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.bindEvent">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>bindEvent
            <span class="apidocSignatureSpan">(ev, target)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.emit">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>emit
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.hasListener">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>hasListener
            <span class="apidocSignatureSpan">(ev, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.listeners">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>listeners
            <span class="apidocSignatureSpan">(ev)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.many">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>many
            <span class="apidocSignatureSpan">(ev, times, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.off">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>off
            <span class="apidocSignatureSpan">(ev, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.on">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>on
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.once">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>once
            <span class="apidocSignatureSpan">(ev, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.proxyEvent">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>proxyEvent
            <span class="apidocSignatureSpan">(ev, ns, target)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.removeAllListeners">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>removeAllListeners
            <span class="apidocSignatureSpan">(ev, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.removeListener">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>removeListener
            <span class="apidocSignatureSpan">(ev, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.unbindEvent">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>unbindEvent
            <span class="apidocSignatureSpan">(ev, target)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super._super.prototype.unproxyEvent">
            function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>unproxyEvent
            <span class="apidocSignatureSpan">(ev, ns, target)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Agent._super.prototype">module apnagent.Agent._super.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype._queueIterator">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>_queueIterator
            <span class="apidocSignatureSpan">(buf, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.close">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>close
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.connect">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>connect
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.createMessage">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>createMessage
            <span class="apidocSignatureSpan">(enc)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.disable">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>disable
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.disabled">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>disabled
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.enable">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>enable
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.enabled">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>enabled
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.get">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>get
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.nextId">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>nextId
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.send">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>send
            <span class="apidocSignatureSpan">(msg, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent._super.prototype.set">
            function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>set
            <span class="apidocSignatureSpan">(key, value)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Agent.prototype">module apnagent.Agent.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent.prototype._queueIterator">
            function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>_queueIterator
            <span class="apidocSignatureSpan">(obj, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent.prototype._reconnect">
            function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>_reconnect
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent.prototype.close">
            function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>close
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Agent.prototype.connect">
            function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>connect
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Device">module apnagent.Device</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Device.Device">
            function <span class="apidocSignatureSpan">apnagent.</span>Device
            <span class="apidocSignatureSpan">(token)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Device.prototype">module apnagent.Device.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Device.prototype.equal">
            function <span class="apidocSignatureSpan">apnagent.Device.prototype.</span>equal
            <span class="apidocSignatureSpan">(dev)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Device.prototype.toBuffer">
            function <span class="apidocSignatureSpan">apnagent.Device.prototype.</span>toBuffer
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Device.prototype.toString">
            function <span class="apidocSignatureSpan">apnagent.Device.prototype.</span>toString
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Feedback">module apnagent.Feedback</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback.Feedback">
            function <span class="apidocSignatureSpan">apnagent.</span>Feedback
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super">
            function <span class="apidocSignatureSpan">apnagent.Feedback.</span>_super
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Feedback._super">module apnagent.Feedback._super</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super._super">
            function <span class="apidocSignatureSpan">apnagent.Feedback.</span>_super
            <span class="apidocSignatureSpan">(opts)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Feedback._super.prototype">module apnagent.Feedback._super.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.close">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>close
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.connect">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>connect
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.disable">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>disable
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.disabled">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>disabled
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.enable">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>enable
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.enabled">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>enabled
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.get">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>get
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.set">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>set
            <span class="apidocSignatureSpan">(key, value)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.unsub">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>unsub
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback._super.prototype.use">
            function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>use
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.Feedback.prototype">module apnagent.Feedback.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback.prototype.close">
            function <span class="apidocSignatureSpan">apnagent.Feedback.prototype.</span>close
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.Feedback.prototype.connect">
            function <span class="apidocSignatureSpan">apnagent.Feedback.prototype.</span>connect
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.MockAgent">module apnagent.MockAgent</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockAgent.MockAgent">
            function <span class="apidocSignatureSpan">apnagent.</span>MockAgent
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockAgent._super">
            function <span class="apidocSignatureSpan">apnagent.MockAgent.</span>_super
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.MockAgent.prototype">module apnagent.MockAgent.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockAgent.prototype._queueIterator">
            function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>_queueIterator
            <span class="apidocSignatureSpan">(obj, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockAgent.prototype.close">
            function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>close
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockAgent.prototype.connect">
            function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>connect
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockAgent.prototype.setBadDevices">
            function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>setBadDevices
            <span class="apidocSignatureSpan">(devices)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.MockFeedback">module apnagent.MockFeedback</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockFeedback.MockFeedback">
            function <span class="apidocSignatureSpan">apnagent.</span>MockFeedback
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockFeedback._super">
            function <span class="apidocSignatureSpan">apnagent.MockFeedback.</span>_super
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.MockFeedback.prototype">module apnagent.MockFeedback.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockFeedback.prototype.close">
            function <span class="apidocSignatureSpan">apnagent.MockFeedback.prototype.</span>close
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockFeedback.prototype.connect">
            function <span class="apidocSignatureSpan">apnagent.MockFeedback.prototype.</span>connect
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.MockFeedback.prototype.unsub">
            function <span class="apidocSignatureSpan">apnagent.MockFeedback.prototype.</span>unsub
            <span class="apidocSignatureSpan">(token, ts)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.apnagent">module apnagent.apnagent</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.apnagent.Agent">
            function <span class="apidocSignatureSpan">apnagent.apnagent.</span>Agent
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.apnagent.Device">
            function <span class="apidocSignatureSpan">apnagent.apnagent.</span>Device
            <span class="apidocSignatureSpan">(token)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.apnagent.Feedback">
            function <span class="apidocSignatureSpan">apnagent.apnagent.</span>Feedback
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.apnagent.MockAgent">
            function <span class="apidocSignatureSpan">apnagent.apnagent.</span>MockAgent
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.apnagent.MockFeedback">
            function <span class="apidocSignatureSpan">apnagent.apnagent.</span>MockFeedback
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">apnagent.apnagent.</span>errors</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">apnagent.apnagent.</span>version</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.cache">module apnagent.cache</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.cache">
            function <span class="apidocSignatureSpan">apnagent.</span>cache
            <span class="apidocSignatureSpan">(ttl)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.cache.prototype">module apnagent.cache.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.prototype.flush">
            function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>flush
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.prototype.get">
            function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>get
            <span class="apidocSignatureSpan">(id)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.prototype.pause">
            function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>pause
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.prototype.push">
            function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>push
            <span class="apidocSignatureSpan">(id, obj, age)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.prototype.resume">
            function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>resume
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.prototype.sinceId">
            function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>sinceId
            <span class="apidocSignatureSpan">(id, iterator)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.cache.prototype.sinceTime">
            function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>sinceTime
            <span class="apidocSignatureSpan">(age, iterator)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors">module apnagent.errors</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>FeedbackAuthorizationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayAuthorizationError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayAuthorizationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayMessageError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayMessageError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.MessageSerializationError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>MessageSerializationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.FeedbackAuthorizationError">module apnagent.errors.FeedbackAuthorizationError</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.FeedbackAuthorizationError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>FeedbackAuthorizationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.FeedbackAuthorizationError.prototype">module apnagent.errors.FeedbackAuthorizationError.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.constructor">
            function <span class="apidocSignatureSpan">apnagent.errors.FeedbackAuthorizationError.prototype.</span>constructor
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.serialize">
            function <span class="apidocSignatureSpan">apnagent.errors.FeedbackAuthorizationError.prototype.</span>serialize
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.toJSON">
            function <span class="apidocSignatureSpan">apnagent.errors.FeedbackAuthorizationError.prototype.</span>toJSON
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">apnagent.errors.FeedbackAuthorizationError.prototype.</span>name</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.GatewayAuthorizationError">module apnagent.errors.GatewayAuthorizationError</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.GatewayAuthorizationError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayAuthorizationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.GatewayAuthorizationError.prototype">module apnagent.errors.GatewayAuthorizationError.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.constructor">
            function <span class="apidocSignatureSpan">apnagent.errors.GatewayAuthorizationError.prototype.</span>constructor
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.serialize">
            function <span class="apidocSignatureSpan">apnagent.errors.GatewayAuthorizationError.prototype.</span>serialize
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.toJSON">
            function <span class="apidocSignatureSpan">apnagent.errors.GatewayAuthorizationError.prototype.</span>toJSON
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">apnagent.errors.GatewayAuthorizationError.prototype.</span>name</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.GatewayMessageError">module apnagent.errors.GatewayMessageError</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayMessageError.GatewayMessageError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayMessageError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.GatewayMessageError.prototype">module apnagent.errors.GatewayMessageError.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayMessageError.prototype.constructor">
            function <span class="apidocSignatureSpan">apnagent.errors.GatewayMessageError.prototype.</span>constructor
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayMessageError.prototype.serialize">
            function <span class="apidocSignatureSpan">apnagent.errors.GatewayMessageError.prototype.</span>serialize
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.GatewayMessageError.prototype.toJSON">
            function <span class="apidocSignatureSpan">apnagent.errors.GatewayMessageError.prototype.</span>toJSON
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">apnagent.errors.GatewayMessageError.prototype.</span>name</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.MessageSerializationError">module apnagent.errors.MessageSerializationError</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.MessageSerializationError.MessageSerializationError">
            function <span class="apidocSignatureSpan">apnagent.errors.</span>MessageSerializationError
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.errors.MessageSerializationError.prototype">module apnagent.errors.MessageSerializationError.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.MessageSerializationError.prototype.constructor">
            function <span class="apidocSignatureSpan">apnagent.errors.MessageSerializationError.prototype.</span>constructor
            <span class="apidocSignatureSpan">(message, props, ssf)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.MessageSerializationError.prototype.serialize">
            function <span class="apidocSignatureSpan">apnagent.errors.MessageSerializationError.prototype.</span>serialize
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.errors.MessageSerializationError.prototype.toJSON">
            function <span class="apidocSignatureSpan">apnagent.errors.MessageSerializationError.prototype.</span>toJSON
            <span class="apidocSignatureSpan">(stack)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">apnagent.errors.MessageSerializationError.prototype.</span>name</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.index">module apnagent.index</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.index.getId">
            function <span class="apidocSignatureSpan">apnagent.index.</span>getId
            <span class="apidocSignatureSpan">(name)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.index.getInterface">
            function <span class="apidocSignatureSpan">apnagent.index.</span>getInterface
            <span class="apidocSignatureSpan">(name, interface)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.message">module apnagent.message</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.message">
            function <span class="apidocSignatureSpan">apnagent.</span>message
            <span class="apidocSignatureSpan">(agent, codec, opts)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.message.prototype">module apnagent.message.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.alert">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>alert
            <span class="apidocSignatureSpan">(key, value)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.badge">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>badge
            <span class="apidocSignatureSpan">(n)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.contentAvailable">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>contentAvailable
            <span class="apidocSignatureSpan">(contentAvailable)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.device">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>device
            <span class="apidocSignatureSpan">(device)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.expires">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>expires
            <span class="apidocSignatureSpan">(time)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.send">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>send
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.serialize">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>serialize
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.set">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>set
            <span class="apidocSignatureSpan">(key, value)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.message.prototype.sound">
            function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>sound
            <span class="apidocSignatureSpan">(sound)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.apnagent.util">module apnagent.util</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.util.feedbackOptions">
            function <span class="apidocSignatureSpan">apnagent.util.</span>feedbackOptions
            <span class="apidocSignatureSpan">(agent)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.util.gatewayOptions">
            function <span class="apidocSignatureSpan">apnagent.util.</span>gatewayOptions
            <span class="apidocSignatureSpan">(agent)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.util.tlsOptions">
            function <span class="apidocSignatureSpan">apnagent.util.</span>tlsOptions
            <span class="apidocSignatureSpan">(agent, opts)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.apnagent.util.trim">
            function <span class="apidocSignatureSpan">apnagent.util.</span>trim
            <span class="apidocSignatureSpan">(str, len)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent" id="apidoc.module.apnagent">module apnagent</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Agent" id="apidoc.element.apnagent.Agent">
        function <span class="apidocSignatureSpan">apnagent.</span>Agent
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Agent() {
  Base.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super" id="apidoc.element.apnagent.Agent._super">
        function <span class="apidocSignatureSpan">apnagent.</span>Agent._super
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Base() {
  EventEmitter.call(this, { delimeter: ':' });
  this.connected = false;

  // default settings
  this.set('cache ttl', '10m');
  this.set('codec', 'enhanced');
  this.set('expires', 0);
  this.enable('reconnect');
  this.set('reconnect delay', 3000);
  this.disable('sandbox');

  // internal storage
  this.meta = {};
  this.meta.lastId = -1;
  this.meta.gatewayError = null;
  this.meta.timer = null;

  var self = this
    , cache, decoder, encoder, queue;

  // temp storage for messages
  cache = new Cache();

  // queue handles writing buffers to gateway
  queue = new Queue(function () {
    debug('(queue) iterate');
    self._queueIterator.apply(self, arguments);
  }, 1);

  // start in paused state
  cache.pause();
  queue.pause();

  // emit queue errors on agent
  queue.onerror = function (err) {
    debug('(queue) error: %s', err.message);
    self.emit('queue:error', err);
  };

  // emit queue drain on agent
  queue.drain = function () {
    debug('(queue) drain');
    self.emit('queue:drain');
  };

  // decoder handles incoming apn errors
  decoder = lotus.createDecoder();
  decoder.stream(8, codecs.getInterface('gateway response', 'decode'));

  // listen for responses
  decoder.stream(8).on('readable', function () {
    var obj = this.read();
    obj.code = obj.code[0];

    var message = notifErrors[obj.code] || 'None (unknown)'
      , err = new errors.GatewayMessageError(message, obj)
      , cached = self.cache.get(obj.identifier)
      , msg = null;

    if (cached) {
      msg = new Message(self, 'enhanced', cached.json.payload);
      msg.device(cached.json.deviceToken);
      msg.meta.expires = cached.json.expiration;
    }

    debug('(message) error: %s', err.message);
    self.meta.gatewayError = err;
    self.emit('message:error', err, msg);
  });

  // encoder handles converting msg json to buffers
  encoder = lotus.createEncoder();
  encoder.stream(0, codecs.getInterface('gateway simple', 'encode'));
  encoder.stream(1, codecs.getInterface('gateway enhanced', 'encode'));

  // mount objects
  this.cache = cache;
  this.decoder = decoder;
  this.encoder = encoder;
  this.gateway = null;
  this.queue = queue;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Device" id="apidoc.element.apnagent.Device">
        function <span class="apidocSignatureSpan">apnagent.</span>Device
        <span class="apidocSignatureSpan">(token)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Device(token) {
<span class="apidocCodeCommentSpan">  /*!
   * @param {String|Buffer|Device} device token
   * @api public
   */
</span>  if (token instanceof Device) {
    token = token.toString();
  }

  this.token = token || undefined;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback" id="apidoc.element.apnagent.Feedback">
        function <span class="apidocSignatureSpan">apnagent.</span>Feedback
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Feedback() {
  Base.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super" id="apidoc.element.apnagent.Feedback._super">
        function <span class="apidocSignatureSpan">apnagent.</span>Feedback._super
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Base() {
  EventEmitter.call(this, { delimeter: ':' });
  this.connected = false;
  this.set('interval', '30m');
  this.disable('sandbox');

  this.meta = {};
  this.meta.timer = null;
  this.meta.stack = [ emit ];

  var self = this
    , decoder, queue;

  // queue handles user interaction with responses
  queue = new Queue(function (obj, done) {
    var device = obj.device
      , stack = self.meta.stack
      , timestamp = obj.timestamp;

    // intercept errors so as not to cancel queue
    function finish (err) {
      if (err) {
        debug('(iterate) error - %s', err.message);
        self.emit('iterate:error', err, device, timestamp);
      }

      debug('(iterate) end - %s', device.toString());
      done();
    }

    // start iteration
    debug('(iterate) start - %s', device.toString());
    series(stack, function (fn, next) {
      fn.apply(self, [ device, timestamp, next ]);
    }, finish);
  }, 10);

  // emit queue errors on feedback agent
  queue.onerror = function (err) {
    debug('(queue) error: %s', err.message);
    self.emit('queue:error', err);
  };

  // emit queue drain on feedback agent
  queue.drain = function () {
    debug('(queue) drain');
    self.emit('queue:drain');
  };

  // decoder handing incoming feedback responses
  decoder = lotus.createDecoder();
  decoder.stream(codecs.getInterface('feedback response', 'decode'));
  decoder.stream().on('readable', function () {
    var obj = this.read()
      , res = {};
    res.device = new Device(obj.deviceToken);
    res.timestamp = new Date(obj.timestamp * 1000);
    queue.push(res, true);
  });

  this.decoder = decoder;
  this.feedback = null;
  this.queue = queue;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockAgent" id="apidoc.element.apnagent.MockAgent">
        function <span class="apidocSignatureSpan">apnagent.</span>MockAgent
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Mock() {
  Base.call(this);

  // Messages sent to these devices will be rejected with error 8 BAD_TOKEN
  this.badDevices = []
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockFeedback" id="apidoc.element.apnagent.MockFeedback">
        function <span class="apidocSignatureSpan">apnagent.</span>MockFeedback
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Mock() {
  Base.call(this);
  this.meta.outgoing = [];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.cache" id="apidoc.element.apnagent.cache">
        function <span class="apidocSignatureSpan">apnagent.</span>cache
        <span class="apidocSignatureSpan">(ttl)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Cache(ttl) {
  this.store = [];
  this.timer = null;
  this.ttl = ttl || '10m';
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError" id="apidoc.element.apnagent.errors.FeedbackAuthorizationError">
        function <span class="apidocSignatureSpan">apnagent.</span>errors.FeedbackAuthorizationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayAuthorizationError" id="apidoc.element.apnagent.errors.GatewayAuthorizationError">
        function <span class="apidocSignatureSpan">apnagent.</span>errors.GatewayAuthorizationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayMessageError" id="apidoc.element.apnagent.errors.GatewayMessageError">
        function <span class="apidocSignatureSpan">apnagent.</span>errors.GatewayMessageError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.MessageSerializationError" id="apidoc.element.apnagent.errors.MessageSerializationError">
        function <span class="apidocSignatureSpan">apnagent.</span>errors.MessageSerializationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message" id="apidoc.element.apnagent.message">
        function <span class="apidocSignatureSpan">apnagent.</span>message
        <span class="apidocSignatureSpan">(agent, codec, opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Message(agent, codec, opts) {
<span class="apidocCodeCommentSpan">  /*!
   * @param {Agent} agent to use for sending
   * @param {String} default codec
   * @param {Object} payload to import
   * @api public
   */
</span>
  this._agent = agent;
  this.encoding = 'utf8';

  this.meta = {};
  this.meta.codec = codec;
  this.meta.device = new Device();
  this.meta.expires = null;

  this.settings = {};
  this.payload = {};
  this.aps = {};

  opts = opts || {};

  // import custom encoding
  if (opts.enc) this.encoding = opts.enc;

  // import custom variables
  for (var name in opts) {
    if (name === 'aps' || name === 'enc') continue;
    this.set(name, opts[name]);
  }

  if (opts.aps) {
    // import badge/sound
    if (opts.aps.badge) this.badge(opts.aps.badge);
    if (opts.aps.sound) this.sound(opts.aps.sound);
    if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);

    // import alert
    if (opts.aps.alert &amp;&amp; 'string' === typeof opts.aps.alert) {
      this.alert('body', opts.aps.alert);
    } else if (opts.aps.alert) {
      this.alert(opts.aps.alert);
    }
  }

  if (agent &amp;&amp; 'simple' !== codec) {
    this.expires(agent.get('expires'));
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>








































</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Agent" id="apidoc.module.apnagent.Agent">module apnagent.Agent</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Agent.Agent" id="apidoc.element.apnagent.Agent.Agent">
        function <span class="apidocSignatureSpan">apnagent.</span>Agent
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Agent() {
  Base.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super" id="apidoc.element.apnagent.Agent._super">
        function <span class="apidocSignatureSpan">apnagent.Agent.</span>_super
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Base() {
  EventEmitter.call(this, { delimeter: ':' });
  this.connected = false;

  // default settings
  this.set('cache ttl', '10m');
  this.set('codec', 'enhanced');
  this.set('expires', 0);
  this.enable('reconnect');
  this.set('reconnect delay', 3000);
  this.disable('sandbox');

  // internal storage
  this.meta = {};
  this.meta.lastId = -1;
  this.meta.gatewayError = null;
  this.meta.timer = null;

  var self = this
    , cache, decoder, encoder, queue;

  // temp storage for messages
  cache = new Cache();

  // queue handles writing buffers to gateway
  queue = new Queue(function () {
    debug('(queue) iterate');
    self._queueIterator.apply(self, arguments);
  }, 1);

  // start in paused state
  cache.pause();
  queue.pause();

  // emit queue errors on agent
  queue.onerror = function (err) {
    debug('(queue) error: %s', err.message);
    self.emit('queue:error', err);
  };

  // emit queue drain on agent
  queue.drain = function () {
    debug('(queue) drain');
    self.emit('queue:drain');
  };

  // decoder handles incoming apn errors
  decoder = lotus.createDecoder();
  decoder.stream(8, codecs.getInterface('gateway response', 'decode'));

  // listen for responses
  decoder.stream(8).on('readable', function () {
    var obj = this.read();
    obj.code = obj.code[0];

    var message = notifErrors[obj.code] || 'None (unknown)'
      , err = new errors.GatewayMessageError(message, obj)
      , cached = self.cache.get(obj.identifier)
      , msg = null;

    if (cached) {
      msg = new Message(self, 'enhanced', cached.json.payload);
      msg.device(cached.json.deviceToken);
      msg.meta.expires = cached.json.expiration;
    }

    debug('(message) error: %s', err.message);
    self.meta.gatewayError = err;
    self.emit('message:error', err, msg);
  });

  // encoder handles converting msg json to buffers
  encoder = lotus.createEncoder();
  encoder.stream(0, codecs.getInterface('gateway simple', 'encode'));
  encoder.stream(1, codecs.getInterface('gateway enhanced', 'encode'));

  // mount objects
  this.cache = cache;
  this.decoder = decoder;
  this.encoder = encoder;
  this.gateway = null;
  this.queue = queue;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Agent._super" id="apidoc.module.apnagent.Agent._super">module apnagent.Agent._super</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super" id="apidoc.element.apnagent.Agent._super._super">
        function <span class="apidocSignatureSpan">apnagent.Agent.</span>_super
        <span class="apidocSignatureSpan">(opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EnhancedEmitter(opts) {
  opts = opts || {};
  this._drip = {};
  this._drip.delimeter = opts.delimeter || ':';
  this._drip.wildcard = opts.wildcard || (opts.delimeter ? true : false);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Agent._super._super.prototype" id="apidoc.module.apnagent.Agent._super._super.prototype">module apnagent.Agent._super._super.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.addListener" id="apidoc.element.apnagent.Agent._super._super.prototype.addListener">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>addListener
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">addListener = function () {
  var map = this._events || (this._events = {})
    , ev = arguments[0]
    , fn = arguments[1]
    , evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter)
    , store = this._events || (this._events = {});

  function iterate (events, map) {
    var event = events.shift();
    map[event] = map[event] || {};

    if (events.length) {
      iterate(events, map[event]);
    } else {
      if (!map[event]._) map[event]._= [ fn ];
      else map[event]._.push(fn);
    }
  };

  iterate(evs, store);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.bindEvent" id="apidoc.element.apnagent.Agent._super._super.prototype.bindEvent">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>bindEvent
        <span class="apidocSignatureSpan">(ev, target)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">bindEvent = function (ev, target) {
  var proxy = eventProxy.call(this, ev, target);
  this.on(ev, proxy);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.emit" id="apidoc.element.apnagent.Agent._super._super.prototype.emit">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>emit
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">emit = function () {
  if (!this._events) return false;

  var ev = arguments[0]
    , evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter)
    , fns = traverse(evs, this._events);

  if (!fns.length) return false;

  var a;
  for (var i = 0, l = fns.length; i &lt; l; i++) {
    if (arguments.length === 1) fns[i].call(this);
    else if (arguments.length === 2) fns[i].call(this, arguments[1]);
    else if (arguments.length === 3) fns[i].call(this, arguments[1], arguments[2]);
    else {
      if (!a) {
        var la = arguments.length
        a = Array(la - 1);
        for (var i2 = 1; i2 &lt; la; i2++) a[i2 - 1] = arguments[i2];
      }
      fns[i].apply(this, a);
    }
  }

  return true;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// start in paused state
cache.pause();
queue.pause();

// emit queue errors on agent
queue.onerror = function (err) {
  debug('(queue) error: %s', err.message);
  self.<span class="apidocCodeKeywordSpan">emit</span>('queue:error', err);
};

// emit queue drain on agent
queue.drain = function () {
  debug('(queue) drain');
  self.emit('queue:drain');
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.hasListener" id="apidoc.element.apnagent.Agent._super._super.prototype.hasListener">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>hasListener
        <span class="apidocSignatureSpan">(ev, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hasListener = function (ev, fn) {
  if (!this._events) return false;
  var evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter)
    , fns = traverse(evs, this._events);
  if (fns.length === 0) return false;
  return common.hasListener(fns, fn);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.listeners" id="apidoc.element.apnagent.Agent._super._super.prototype.listeners">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>listeners
        <span class="apidocSignatureSpan">(ev)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">listeners = function (ev) {
  if (!this._events) return [];
  var evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter)
    , fns = traverse(evs, this._events);
  return fns;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.many" id="apidoc.element.apnagent.Agent._super._super.prototype.many">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>many
        <span class="apidocSignatureSpan">(ev, times, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">many = function (ev, times, fn) {
  var self = this;

  function wrap () {
    if (--times === 0) self.off(ev, wrap);
    fn.apply(null, arguments);
  };

  this.on(ev, wrap);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.off" id="apidoc.element.apnagent.Agent._super._super.prototype.off">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>off
        <span class="apidocSignatureSpan">(ev, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">off = function (ev, fn) {
  if (!this._events || arguments.length === 0) {
    this._events = {};
    return this;
  }

  var evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter);

  if (evs.length === 1 &amp;&amp; !fn) {
    if (this._events[ev]) this._events[ev]._ = null;
    return this;
  } else {
    function isEmpty (obj) {
      for (var name in obj)
        if (obj[name] &amp;&amp; name != '_') return false;
      return true;
    };

    function clean (event) {
      if (fn &amp;&amp; 'function' === typeof fn) {
        for (var i = 0; i &lt; event._.length; i++)
          if (fn == event._[i]) event._.splice(i, 1);
        if (event._.length === 0) event._ = null;
        if (event._ &amp;&amp; event._.length == 1) event._ = event._[0];
      } else {
        event._ = null;
      }

      if (!event._ &amp;&amp; isEmpty(event)) event = null;
      return event;
    };

    function iterate (events, map) {
      var event = events.shift();
      if (map[event] &amp;&amp; map[event]._ &amp;&amp; !events.length) map[event] = clean(map[event]);
      if (map[event] &amp;&amp; events.length) map[event] = iterate(events, map[event]);
      if (!map[event] &amp;&amp; isEmpty(map)) map = null;
      return map;
    };

    this._events = iterate(evs, this._events);
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.on" id="apidoc.element.apnagent.Agent._super._super.prototype.on">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>on
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">on = function () {
  var map = this._events || (this._events = {})
    , ev = arguments[0]
    , fn = arguments[1]
    , evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter)
    , store = this._events || (this._events = {});

  function iterate (events, map) {
    var event = events.shift();
    map[event] = map[event] || {};

    if (events.length) {
      iterate(events, map[event]);
    } else {
      if (!map[event]._) map[event]._= [ fn ];
      else map[event]._.push(fn);
    }
  };

  iterate(evs, store);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  };

  // decoder handles incoming apn errors
  decoder = lotus.createDecoder();
  decoder.stream(8, codecs.getInterface('gateway response', 'decode'));

  // listen for responses
  decoder.stream(8).<span class="apidocCodeKeywordSpan">on</span>('readable', function () {
var obj = this.read();
obj.code = obj.code[0];

var message = notifErrors[obj.code] || 'None (unknown)'
  , err = new errors.GatewayMessageError(message, obj)
  , cached = self.cache.get(obj.identifier)
  , msg = null;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.once" id="apidoc.element.apnagent.Agent._super._super.prototype.once">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>once
        <span class="apidocSignatureSpan">(ev, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">once = function (ev, fn) {
  this.many(ev, 1, fn);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var self = this
  , drain = this.queue.drain;

// wait for queue to finish processing current
this.queue.drain = function () {
  debug('(gateway) disconnecting');
  self.cache.pause();
  self.gateway.<span class="apidocCodeKeywordSpan">once</span>('close', cb);
  self.gateway.destroy();
  self.queue.drain = drain;
};

// set things in motion
this.connected = false;
this.queue.pause();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.proxyEvent" id="apidoc.element.apnagent.Agent._super._super.prototype.proxyEvent">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>proxyEvent
        <span class="apidocSignatureSpan">(ev, ns, target)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">proxyEvent = function (ev, ns, target) {
  if (arguments.length === 2) target = ns, ns = null;
  var drip = this._drip || {}
    , listen = !drip.delimeter
      ? (ns  ? ns + ':' + ev : ev)
      : (ns
        ? (Array.isArray(ns)
          ? concat(ns, [ ev ])
          : concat(ns.split(drip.delimeter), [ ev ]))
        : ev);

  target.addListener(ev, eventProxy.call(this, listen, this));
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.removeAllListeners" id="apidoc.element.apnagent.Agent._super._super.prototype.removeAllListeners">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>removeAllListeners
        <span class="apidocSignatureSpan">(ev, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">removeAllListeners = function (ev, fn) {
  if (!this._events || arguments.length === 0) {
    this._events = {};
    return this;
  }

  var evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter);

  if (evs.length === 1 &amp;&amp; !fn) {
    if (this._events[ev]) this._events[ev]._ = null;
    return this;
  } else {
    function isEmpty (obj) {
      for (var name in obj)
        if (obj[name] &amp;&amp; name != '_') return false;
      return true;
    };

    function clean (event) {
      if (fn &amp;&amp; 'function' === typeof fn) {
        for (var i = 0; i &lt; event._.length; i++)
          if (fn == event._[i]) event._.splice(i, 1);
        if (event._.length === 0) event._ = null;
        if (event._ &amp;&amp; event._.length == 1) event._ = event._[0];
      } else {
        event._ = null;
      }

      if (!event._ &amp;&amp; isEmpty(event)) event = null;
      return event;
    };

    function iterate (events, map) {
      var event = events.shift();
      if (map[event] &amp;&amp; map[event]._ &amp;&amp; !events.length) map[event] = clean(map[event]);
      if (map[event] &amp;&amp; events.length) map[event] = iterate(events, map[event]);
      if (!map[event] &amp;&amp; isEmpty(map)) map = null;
      return map;
    };

    this._events = iterate(evs, this._events);
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.removeListener" id="apidoc.element.apnagent.Agent._super._super.prototype.removeListener">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>removeListener
        <span class="apidocSignatureSpan">(ev, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">removeListener = function (ev, fn) {
  if (!this._events || arguments.length === 0) {
    this._events = {};
    return this;
  }

  var evs = Array.isArray(ev)
      ? ev.slice(0)
      : ev.split(this._drip.delimeter);

  if (evs.length === 1 &amp;&amp; !fn) {
    if (this._events[ev]) this._events[ev]._ = null;
    return this;
  } else {
    function isEmpty (obj) {
      for (var name in obj)
        if (obj[name] &amp;&amp; name != '_') return false;
      return true;
    };

    function clean (event) {
      if (fn &amp;&amp; 'function' === typeof fn) {
        for (var i = 0; i &lt; event._.length; i++)
          if (fn == event._[i]) event._.splice(i, 1);
        if (event._.length === 0) event._ = null;
        if (event._ &amp;&amp; event._.length == 1) event._ = event._[0];
      } else {
        event._ = null;
      }

      if (!event._ &amp;&amp; isEmpty(event)) event = null;
      return event;
    };

    function iterate (events, map) {
      var event = events.shift();
      if (map[event] &amp;&amp; map[event]._ &amp;&amp; !events.length) map[event] = clean(map[event]);
      if (map[event] &amp;&amp; events.length) map[event] = iterate(events, map[event]);
      if (!map[event] &amp;&amp; isEmpty(map)) map = null;
      return map;
    };

    this._events = iterate(evs, this._events);
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.unbindEvent" id="apidoc.element.apnagent.Agent._super._super.prototype.unbindEvent">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>unbindEvent
        <span class="apidocSignatureSpan">(ev, target)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unbindEvent = function (ev, target) {
  var proxy = eventProxy.call(this, ev, target);
  this.off(ev, proxy);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super._super.prototype.unproxyEvent" id="apidoc.element.apnagent.Agent._super._super.prototype.unproxyEvent">
        function <span class="apidocSignatureSpan">apnagent.Agent._super._super.prototype.</span>unproxyEvent
        <span class="apidocSignatureSpan">(ev, ns, target)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unproxyEvent = function (ev, ns, target) {
  if (arguments.length === 2) target = ns, ns = null;
  var drip = this._drip || {}
    , listen = !drip.delimeter
      ? (ns  ? ns + ':' + ev : ev)
      : (ns
        ? (Array.isArray(ns)
          ? concat(ns, [ ev ])
          : concat(ns.split(drip.delimeter), [ ev ]))
        : ev);

  target.removeListener(ev, eventProxy.call(this, listen, this));
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Agent._super.prototype" id="apidoc.module.apnagent.Agent._super.prototype">module apnagent.Agent._super.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype._queueIterator" id="apidoc.element.apnagent.Agent._super.prototype._queueIterator">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>_queueIterator
        <span class="apidocSignatureSpan">(buf, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_queueIterator = function (buf, next) {
  throw new Error('Queue iterator not implemented.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.close" id="apidoc.element.apnagent.Agent._super.prototype.close">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>close
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function () {
  throw new Error('Gateway close not implemented');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1.0.0 / 2013-03-27
==================

* pkg: update description
* docs: update
* feedback: [base] change default interval
* agent: [all] reconnect now cancelled by .<span class="apidocCodeKeywordSpan">close</span>()
* docs: add resources section
* docs: color scheme
* docs: checkpoint - agent docs ready for proofread
* agent: [base] documentation
* agent: [mock/live] fix reference to stored gateway error
* Merge branch 'refactor/node10'
* feedback: [base/mock] convert to new lotus api
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.connect" id="apidoc.element.apnagent.Agent._super.prototype.connect">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>connect
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect = function () {
  throw new Error('Gateway connect not implemented.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    self.cache.sinceId(gwe.identifier, function (obj, id) {
      debug('(queue) push: %d', id);
      self.queue.pushAt(pos++, obj);
    });
  }

  debug('(gateway) reconnecting');
  self.<span class="apidocCodeKeywordSpan">connect</span>(function (err) {
    if (err) return;
    debug('(gateway) reconnected');
    self.emit('gateway:reconnect');
  });
};

/**
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.createMessage" id="apidoc.element.apnagent.Agent._super.prototype.createMessage">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>createMessage
        <span class="apidocSignatureSpan">(enc)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createMessage = function (enc) {
  var codec = this.get('codec');
  return new Message(this, codec, { enc: enc });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * builder is a chainable API that provides full feature
 * coverage of the Apple Push Notification specifications.
 *
 * The preferred method of composing messages is directly
 * from a constructed `Agent` or `MockAgent`.
 *
 * ```js
 * var msg = agent.<span class="apidocCodeKeywordSpan">createMessage</span>();
 * ```
 *
 * @header Message Builder API
 */

function Message (agent, codec, opts) {
/*!
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.disable" id="apidoc.element.apnagent.Agent._super.prototype.disable">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>disable
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">disable = function (key) {
  return this.set(key, false);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// default settings
this.set('cache ttl', '10m');
this.set('codec', 'enhanced');
this.set('expires', 0);
this.enable('reconnect');
this.set('reconnect delay', 3000);
this.<span class="apidocCodeKeywordSpan">disable</span>('sandbox');

// internal storage
this.meta = {};
this.meta.lastId = -1;
this.meta.gatewayError = null;
this.meta.timer = null;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.disabled" id="apidoc.element.apnagent.Agent._super.prototype.disabled">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>disabled
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">disabled = function (key) {
  return !!! this.get(key);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.enable" id="apidoc.element.apnagent.Agent._super.prototype.enable">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>enable
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">enable = function (key) {
  return this.set(key, true);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
EventEmitter.call(this, { delimeter: ':' });
this.connected = false;

// default settings
this.set('cache ttl', '10m');
this.set('codec', 'enhanced');
this.set('expires', 0);
this.<span class="apidocCodeKeywordSpan">enable</span>('reconnect');
this.set('reconnect delay', 3000);
this.disable('sandbox');

// internal storage
this.meta = {};
this.meta.lastId = -1;
this.meta.gatewayError = null;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.enabled" id="apidoc.element.apnagent.Agent._super.prototype.enabled">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>enabled
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">enabled = function (key) {
  return !! this.get(key);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
return res + '...';
};

exports.gatewayOptions = function (agent) {
var opts = {};

// get the tls host based on sandbox
opts.host = agent.<span class="apidocCodeKeywordSpan">enabled</span>('sandbox')
  ? APNS_SANDBOX
  : APNS_PROD;

// use default port
opts.port = APNS_PORT;

// pull in tls options
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.get" id="apidoc.element.apnagent.Agent._super.prototype.get">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>get
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function (key) {
  return this.set(key);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
     this.alert('body', opts.aps.alert);
   } else if (opts.aps.alert) {
     this.alert(opts.aps.alert);
   }
 }

 if (agent &amp;&amp; 'simple' !== codec) {
   this.expires(agent.<span class="apidocCodeKeywordSpan">get</span>('expires'));
 }
}

/**
* ### .alert (key, value)
*
* Sets variables to be included in the `alert` dictionary
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.nextId" id="apidoc.element.apnagent.Agent._super.prototype.nextId">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>nextId
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">nextId = function () {
  var i = ++this.meta.lastId;

  if (i &gt; INT32) {
    i = this.meta.lastId = 0;
  }

  return i;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 }

 // construct the response
 var res = {};
 res.deviceToken = this.meta.device.toBuffer();
 res.expiration = this.meta.expires
 res.identifier = this._agent
   ? this._agent.<span class="apidocCodeKeywordSpan">nextId</span>()
   : null;
 res.payload = payload;
 return res;
};

/**
* ### .send (cb)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.send" id="apidoc.element.apnagent.Agent._super.prototype.send">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>send
        <span class="apidocSignatureSpan">(msg, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">send = function (msg, cb) {
  cb = cb || function () {};

  var self = this
    , codecStr = msg.meta.codec
    , codec = codecs.getId('gateway ' + codecStr)
    , json;

  // handle error
  function error (err) {
    process.nextTick(function () {
      debug('(message) error: %s', err.message);
      cb(err);
      self.emit('message:error', err, msg);
    });
  }

  // check for codec
  if (!~[ 0, 1 ].indexOf(codec)) {
    error(new errors.SerializationError('Invalid codec: ' + codecStr));
    return this;
  }

  // serialize the message
  try {
    json = msg.serialize();
  } catch (ex) {
    error(ex);
    return this;
  }

  // write json to to the queue
  debug('(queue) push: %d', json.identifier);
  this.queue.push({ codec: codec, json: json }, cb, true);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
* deps: update with tea-inherits
* agent: [old] remove single class agent

0.2.0 / 2013-01-15
==================

* docs: update readme and package contribs
* message: [send] pseudo-alias to msg._agent.<span class="apidocCodeKeywordSpan">send</span>(this, cb)
* Merge branch 'feature/reconnect'
* test: [agent] should be able to reconnect
* agent: [connect] support for reconnnect
* Merge branch 'feature/events'
* agent: events, custom errors, and improved codec lookup
* errors: add custom errors and expose via exports.errors
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent._super.prototype.set" id="apidoc.element.apnagent.Agent._super.prototype.set">
        function <span class="apidocSignatureSpan">apnagent.Agent._super.prototype.</span>set
        <span class="apidocSignatureSpan">(key, value)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">set = function (key, value) {
  var settings = this[prop] || (this[prop] = {});

  if (1 === arguments.length) {
    if ('string' === typeof key) {
      return settings[key];
    } else {
      for (var name in key) {
        this.set(name, key[name]);
      }
    }
  } else {
    settings[key] = value;
    handle.call(this, key, value);
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// import custom encoding
if (opts.enc) this.encoding = opts.enc;

// import custom variables
for (var name in opts) {
  if (name === 'aps' || name === 'enc') continue;
  this.<span class="apidocCodeKeywordSpan">set</span>(name, opts[name]);
}

if (opts.aps) {
  // import badge/sound
  if (opts.aps.badge) this.badge(opts.aps.badge);
  if (opts.aps.sound) this.sound(opts.aps.sound);
  if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Agent.prototype" id="apidoc.module.apnagent.Agent.prototype">module apnagent.Agent.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Agent.prototype._queueIterator" id="apidoc.element.apnagent.Agent.prototype._queueIterator">
        function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>_queueIterator
        <span class="apidocSignatureSpan">(obj, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_queueIterator = function (obj, next) {
  var self = this
    , cache = this.cache
    , encoder = this.encoder
    , stream = encoder.stream(obj.codec)
    , id = obj.json.identifier
    , queue = this.queue;

  // wait for encoded message
  encoder.once('readable', function () {
    var buf = encoder.read()
      , gateway = self.gateway;

    // requeue if not connected
    if (!gateway || !gateway.writable || !self.connected) {
      debug('(queue) pause: not connected');
      queue.pause();
      queue.pushAt(0, obj);
      return next();
    }

    debug('(gateway) write: %d', id);
    gateway.write(buf, function () {
      debug('(cache) push: %d', id);
      cache.push(id, obj);
      next();
    });
  });

  // encode message
  debug('(encoder) write: %d', id);
  stream.write(obj.json);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent.prototype._reconnect" id="apidoc.element.apnagent.Agent.prototype._reconnect">
        function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>_reconnect
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_reconnect = function (){
  var self = this
    , gwe = self.meta.gatewayError
    , pos = 0;

  if (gwe &amp;&amp; 'undefined' !== typeof gwe.identifier) {
    debug('(cache) since: %d', gwe.identifier);
    self.cache.sinceId(gwe.identifier, function (obj, id) {
      debug('(queue) push: %d', id);
      self.queue.pushAt(pos++, obj);
    });
  }

  debug('(gateway) reconnecting');
  self.connect(function (err) {
    if (err) return;
    debug('(gateway) reconnected');
    self.emit('gateway:reconnect');
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
/*!
* Inherits from Base
*/

inherits(Agent, Base);

/**
* .<span class="apidocCodeKeywordSpan">_reconnect</span>()
*
* Establish the broken connection again
*
* @name _reconnect
* @api private
*/
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent.prototype.close" id="apidoc.element.apnagent.Agent.prototype.close">
        function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>close
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function (cb) {
  cb = cb || function () {};

  // leave if nothing needs to be done
  if (!this.connected || !this.gateway) {
    clearTimeout(this.meta.timer);
    process.nextTick(cb);
    return this;
  }

  var self = this
    , drain = this.queue.drain;

  // wait for queue to finish processing current
  this.queue.drain = function () {
    debug('(gateway) disconnecting');
    self.cache.pause();
    self.gateway.once('close', cb);
    self.gateway.destroy();
    self.queue.drain = drain;
  };

  // set things in motion
  this.connected = false;
  this.queue.pause();
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1.0.0 / 2013-03-27
==================

* pkg: update description
* docs: update
* feedback: [base] change default interval
* agent: [all] reconnect now cancelled by .<span class="apidocCodeKeywordSpan">close</span>()
* docs: add resources section
* docs: color scheme
* docs: checkpoint - agent docs ready for proofread
* agent: [base] documentation
* agent: [mock/live] fix reference to stored gateway error
* Merge branch 'refactor/node10'
* feedback: [base/mock] convert to new lotus api
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Agent.prototype.connect" id="apidoc.element.apnagent.Agent.prototype.connect">
        function <span class="apidocSignatureSpan">apnagent.Agent.prototype.</span>connect
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect = function (cb) {
  cb = cb || function () {};

  var self = this
    , delay = this.get('reconnect delay')
    , opts = util.gatewayOptions(this)
    , recon = this.enabled('reconnect')
    , ttl = this.get('cache ttl')
    , gateway;

  // don't try to connect without credentials
  if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
    process.nextTick(function () {
      var err = new errors.GatewayAuthorizationError('Insufficient credentials');
      debug('(gateway) error: %s', err.message);
      self.emit('gateway:error', err);
      cb(err);
    });

    return this;
  }

  // reset state
  this.meta.gatewayError = null;

  // connect to gateway
  debug('(gateway) connecting - %s:%d', opts.host, opts.port);
  gateway = tls.connect(opts, function () {
    if (gateway.authorized) {
      debug('(gateway) connected - %s:%d', opts.host, opts.port);
      self.connected = true;
      self.cache.ttl = ttl;
      self.cache.resume();
      self.queue.resume();
      self.emit('gateway:connect');
      cb();
    } else {
      var err = new errors.GatewayAuthorizationError(gateway.authorizationError);
      debug('(gateway) unauthorized - %s:%d', opts.host, opts.port, gateway.authorizationError);
      self.gateway.destroy();
      self.emit('gateway:error', err);
      cb(err);
    }
  });

  // handle a disconnection
  gateway.on('close', function () {
    self.cache.pause();
    self.queue.pause();
    self.gateway = null;

    if (self.connected &amp;&amp; recon) {
      debug('(gateway) disconnected - %s:%d', opts.host, opts.port);
      self.connected = false;
      self.meta.timer = setTimeout(self._reconnect.bind(self), ms(delay));
    } else {
      debug('(gateway) closed - %s:%d', opts.host, opts.port);
      self.connected = false;
      self.emit('gateway:close');
    }
  });

  // handle incoming data
  gateway.on('data', function (buf) {
    debug('(gateway) data: %d bytes', buf.length);
    self.decoder.write(buf);
  });

  // emit errors;
  gateway.on('error', function (err) {
    debug('(gateway) error: %s', err.message || 'Unspecified Error');
    if (self.gateway) self.gateway.destroy();
    self.emit('gateway:error', err);
  });

  // mount
  this.gateway = gateway;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    self.cache.sinceId(gwe.identifier, function (obj, id) {
      debug('(queue) push: %d', id);
      self.queue.pushAt(pos++, obj);
    });
  }

  debug('(gateway) reconnecting');
  self.<span class="apidocCodeKeywordSpan">connect</span>(function (err) {
    if (err) return;
    debug('(gateway) reconnected');
    self.emit('gateway:reconnect');
  });
};

/**
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Device" id="apidoc.module.apnagent.Device">module apnagent.Device</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Device.Device" id="apidoc.element.apnagent.Device.Device">
        function <span class="apidocSignatureSpan">apnagent.</span>Device
        <span class="apidocSignatureSpan">(token)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Device(token) {
<span class="apidocCodeCommentSpan">  /*!
   * @param {String|Buffer|Device} device token
   * @api public
   */
</span>  if (token instanceof Device) {
    token = token.toString();
  }

  this.token = token || undefined;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Device.prototype" id="apidoc.module.apnagent.Device.prototype">module apnagent.Device.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Device.prototype.equal" id="apidoc.element.apnagent.Device.prototype.equal">
        function <span class="apidocSignatureSpan">apnagent.Device.prototype.</span>equal
        <span class="apidocSignatureSpan">(dev)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">equal = function (dev) {
  var token1 = this.toString()
    , token2 = dev instanceof Device
      ? dev.toString()
      : stringify(dev);

  return token1
    &amp;&amp; token2
    &amp;&amp; token1 === token2;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
* Compare the stored device token to another
* device, string, or buffer. Will also return false
* if both Devices do not have tokens associated with
* them.
*
* ```js
* // testing string
* device.<span class="apidocCodeKeywordSpan">equal</span>('a1b56d2c08f621d87060da2b').should.be.true;
*
* // testing another device
* var dev2 = new Device('feedface');
* device.equal(dev2).should.be.false;
* ```
*
* @param {Mixed} instance of Device, String, or Buffer
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Device.prototype.toBuffer" id="apidoc.element.apnagent.Device.prototype.toBuffer">
        function <span class="apidocSignatureSpan">apnagent.Device.prototype.</span>toBuffer
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toBuffer = function () {
  return bufferize(this.token);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

/**
* ### .toBuffer ()
*
* Convert the stored device token to a buffer.
*
* ```js
* var buf = device.<span class="apidocCodeKeywordSpan">toBuffer</span>();
* ```
*
* @return {Buffer}
* @api public
* @name toBuffer
*/
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Device.prototype.toString" id="apidoc.element.apnagent.Device.prototype.toString">
        function <span class="apidocSignatureSpan">apnagent.Device.prototype.</span>toString
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toString = function () {
  return stringify(this.token);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

function Device (token) {
 /*!
  * @param {String|Buffer|Device} device token
  * @api public
  */
 if (token instanceof Device) {
   token = token.<span class="apidocCodeKeywordSpan">toString</span>();
 }

 this.token = token || undefined;
}

/**
* ### .toBuffer ()
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Feedback" id="apidoc.module.apnagent.Feedback">module apnagent.Feedback</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Feedback.Feedback" id="apidoc.element.apnagent.Feedback.Feedback">
        function <span class="apidocSignatureSpan">apnagent.</span>Feedback
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Feedback() {
  Base.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super" id="apidoc.element.apnagent.Feedback._super">
        function <span class="apidocSignatureSpan">apnagent.Feedback.</span>_super
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Base() {
  EventEmitter.call(this, { delimeter: ':' });
  this.connected = false;
  this.set('interval', '30m');
  this.disable('sandbox');

  this.meta = {};
  this.meta.timer = null;
  this.meta.stack = [ emit ];

  var self = this
    , decoder, queue;

  // queue handles user interaction with responses
  queue = new Queue(function (obj, done) {
    var device = obj.device
      , stack = self.meta.stack
      , timestamp = obj.timestamp;

    // intercept errors so as not to cancel queue
    function finish (err) {
      if (err) {
        debug('(iterate) error - %s', err.message);
        self.emit('iterate:error', err, device, timestamp);
      }

      debug('(iterate) end - %s', device.toString());
      done();
    }

    // start iteration
    debug('(iterate) start - %s', device.toString());
    series(stack, function (fn, next) {
      fn.apply(self, [ device, timestamp, next ]);
    }, finish);
  }, 10);

  // emit queue errors on feedback agent
  queue.onerror = function (err) {
    debug('(queue) error: %s', err.message);
    self.emit('queue:error', err);
  };

  // emit queue drain on feedback agent
  queue.drain = function () {
    debug('(queue) drain');
    self.emit('queue:drain');
  };

  // decoder handing incoming feedback responses
  decoder = lotus.createDecoder();
  decoder.stream(codecs.getInterface('feedback response', 'decode'));
  decoder.stream().on('readable', function () {
    var obj = this.read()
      , res = {};
    res.device = new Device(obj.deviceToken);
    res.timestamp = new Date(obj.timestamp * 1000);
    queue.push(res, true);
  });

  this.decoder = decoder;
  this.feedback = null;
  this.queue = queue;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Feedback._super" id="apidoc.module.apnagent.Feedback._super">module apnagent.Feedback._super</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super._super" id="apidoc.element.apnagent.Feedback._super._super">
        function <span class="apidocSignatureSpan">apnagent.Feedback.</span>_super
        <span class="apidocSignatureSpan">(opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EnhancedEmitter(opts) {
  opts = opts || {};
  this._drip = {};
  this._drip.delimeter = opts.delimeter || ':';
  this._drip.wildcard = opts.wildcard || (opts.delimeter ? true : false);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Feedback._super.prototype" id="apidoc.module.apnagent.Feedback._super.prototype">module apnagent.Feedback._super.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.close" id="apidoc.element.apnagent.Feedback._super.prototype.close">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>close
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function () {
  throw new Error('Feedback close not implemented.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1.0.0 / 2013-03-27
==================

* pkg: update description
* docs: update
* feedback: [base] change default interval
* agent: [all] reconnect now cancelled by .<span class="apidocCodeKeywordSpan">close</span>()
* docs: add resources section
* docs: color scheme
* docs: checkpoint - agent docs ready for proofread
* agent: [base] documentation
* agent: [mock/live] fix reference to stored gateway error
* Merge branch 'refactor/node10'
* feedback: [base/mock] convert to new lotus api
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.connect" id="apidoc.element.apnagent.Feedback._super.prototype.connect">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>connect
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect = function () {
  throw new Error('Feedback connect not implemented.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    self.cache.sinceId(gwe.identifier, function (obj, id) {
      debug('(queue) push: %d', id);
      self.queue.pushAt(pos++, obj);
    });
  }

  debug('(gateway) reconnecting');
  self.<span class="apidocCodeKeywordSpan">connect</span>(function (err) {
    if (err) return;
    debug('(gateway) reconnected');
    self.emit('gateway:reconnect');
  });
};

/**
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.disable" id="apidoc.element.apnagent.Feedback._super.prototype.disable">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>disable
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">disable = function (key) {
  return this.set(key, false);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// default settings
this.set('cache ttl', '10m');
this.set('codec', 'enhanced');
this.set('expires', 0);
this.enable('reconnect');
this.set('reconnect delay', 3000);
this.<span class="apidocCodeKeywordSpan">disable</span>('sandbox');

// internal storage
this.meta = {};
this.meta.lastId = -1;
this.meta.gatewayError = null;
this.meta.timer = null;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.disabled" id="apidoc.element.apnagent.Feedback._super.prototype.disabled">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>disabled
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">disabled = function (key) {
  return !!! this.get(key);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.enable" id="apidoc.element.apnagent.Feedback._super.prototype.enable">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>enable
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">enable = function (key) {
  return this.set(key, true);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
EventEmitter.call(this, { delimeter: ':' });
this.connected = false;

// default settings
this.set('cache ttl', '10m');
this.set('codec', 'enhanced');
this.set('expires', 0);
this.<span class="apidocCodeKeywordSpan">enable</span>('reconnect');
this.set('reconnect delay', 3000);
this.disable('sandbox');

// internal storage
this.meta = {};
this.meta.lastId = -1;
this.meta.gatewayError = null;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.enabled" id="apidoc.element.apnagent.Feedback._super.prototype.enabled">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>enabled
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">enabled = function (key) {
  return !! this.get(key);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
return res + '...';
};

exports.gatewayOptions = function (agent) {
var opts = {};

// get the tls host based on sandbox
opts.host = agent.<span class="apidocCodeKeywordSpan">enabled</span>('sandbox')
  ? APNS_SANDBOX
  : APNS_PROD;

// use default port
opts.port = APNS_PORT;

// pull in tls options
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.get" id="apidoc.element.apnagent.Feedback._super.prototype.get">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>get
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function (key) {
  return this.set(key);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
     this.alert('body', opts.aps.alert);
   } else if (opts.aps.alert) {
     this.alert(opts.aps.alert);
   }
 }

 if (agent &amp;&amp; 'simple' !== codec) {
   this.expires(agent.<span class="apidocCodeKeywordSpan">get</span>('expires'));
 }
}

/**
* ### .alert (key, value)
*
* Sets variables to be included in the `alert` dictionary
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.set" id="apidoc.element.apnagent.Feedback._super.prototype.set">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>set
        <span class="apidocSignatureSpan">(key, value)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">set = function (key, value) {
  var settings = this[prop] || (this[prop] = {});

  if (1 === arguments.length) {
    if ('string' === typeof key) {
      return settings[key];
    } else {
      for (var name in key) {
        this.set(name, key[name]);
      }
    }
  } else {
    settings[key] = value;
    handle.call(this, key, value);
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// import custom encoding
if (opts.enc) this.encoding = opts.enc;

// import custom variables
for (var name in opts) {
  if (name === 'aps' || name === 'enc') continue;
  this.<span class="apidocCodeKeywordSpan">set</span>(name, opts[name]);
}

if (opts.aps) {
  // import badge/sound
  if (opts.aps.badge) this.badge(opts.aps.badge);
  if (opts.aps.sound) this.sound(opts.aps.sound);
  if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.unsub" id="apidoc.element.apnagent.Feedback._super.prototype.unsub">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>unsub
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unsub = function () {}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback._super.prototype.use" id="apidoc.element.apnagent.Feedback._super.prototype.use">
        function <span class="apidocSignatureSpan">apnagent.Feedback._super.prototype.</span>use
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">use = function (fn) {
  this.meta.stack.push(fn);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var codecs = [];

/**
* Get one of the interfaces from a selected
* codec. For example...
*
* ```js
* writer.<span class="apidocCodeKeywordSpan">use</span>(0, exports.getInterface('gateway simple', 'writer'));
* ```
*
* @param {String} codec name
* @param {String} codec interface
* @return {Object} lotus reader/writer
* @api public
*/
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.Feedback.prototype" id="apidoc.module.apnagent.Feedback.prototype">module apnagent.Feedback.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.Feedback.prototype.close" id="apidoc.element.apnagent.Feedback.prototype.close">
        function <span class="apidocSignatureSpan">apnagent.Feedback.prototype.</span>close
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function (cb) {
  cb = cb || function () {};

  // if not connected, cancel reconnect time
  if (!this.connected || !this.feedback) {
    clearTimeout(this.meta.timer);
    process.nextTick(cb);
    return this;
  }

  // wait for feedback to finish download
  this.feedback.once('end', cb);
  this.connected = false;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1.0.0 / 2013-03-27
==================

* pkg: update description
* docs: update
* feedback: [base] change default interval
* agent: [all] reconnect now cancelled by .<span class="apidocCodeKeywordSpan">close</span>()
* docs: add resources section
* docs: color scheme
* docs: checkpoint - agent docs ready for proofread
* agent: [base] documentation
* agent: [mock/live] fix reference to stored gateway error
* Merge branch 'refactor/node10'
* feedback: [base/mock] convert to new lotus api
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.Feedback.prototype.connect" id="apidoc.element.apnagent.Feedback.prototype.connect">
        function <span class="apidocSignatureSpan">apnagent.Feedback.prototype.</span>connect
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect = function (cb) {
  cb = cb || function () {};

  var self = this
    , interval = this.get('interval')
    , opts = util.feedbackOptions(this)
    , feedback;

  // don't try to connect without credentials
  if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
    process.nextTick(function () {
      var err = new errors.FeedbackAuthorizationError('Insufficient credentials');
      debug('(feedback) error: %s', err.message);
      self.emit('feedback:error', err);
      cb(err);
    });

    return this;
  }

  // how to perform a reconnect
  function reconnect () {
    debug('(feedback) reconnecting');
    self.connect(function (err) {
      if (err) return;
      debug('(feedback) reconnected');
      self.emit('feedback:reconnect');
    });
  }

  // connect to feedback service
  feedback = tls.connect(opts, function () {
    if (feedback.authorized) {
      debug('(feedback) connected - %s:%d', opts.host, opts.port);
      self.connected = true;
      self.emit('feedback:connect');
      cb();
    } else {
      var err = new error.FeedbackAuthorizationError(gateway.authorizationError);
      debug('(feedback) unauthorized - %s:%d', opts.host, opts.port, gateway.authorizationError);
      self.feedback.destroy();
      self.emit('gateway:error', err);
      cb(err);
    }
  });

  // handle a disconnection (expected)
  feedback.on('close', function () {
    self.feedback = null;

    if (self.connected) {
      debug('(feedback) disconnected - %s:%d', opts.host, opts.port);
      self.connected = false;
      self.meta.timer = setTimeout(reconnect, ms(interval));
    } else {
      debug('(feedback) closed - %s:%d', opts.host, opts.port);
      self.connected = false;
      self.emit('feedback:close');
    }
  });

  // handle incoming data
  feedback.on('data', function (buf) {
    debug('(feedback) data: %d bytes', buf.length);
    self.decoder.write(buf);
  });

  // emit errors;
  feedback.on('error', function (err) {
    debug('(feedback) error: %s', err.message || 'Unspecified Error');
    self.emit('feedback:error', err);
  });

  // mount
  this.feedback = feedback;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    self.cache.sinceId(gwe.identifier, function (obj, id) {
      debug('(queue) push: %d', id);
      self.queue.pushAt(pos++, obj);
    });
  }

  debug('(gateway) reconnecting');
  self.<span class="apidocCodeKeywordSpan">connect</span>(function (err) {
    if (err) return;
    debug('(gateway) reconnected');
    self.emit('gateway:reconnect');
  });
};

/**
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.MockAgent" id="apidoc.module.apnagent.MockAgent">module apnagent.MockAgent</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.MockAgent.MockAgent" id="apidoc.element.apnagent.MockAgent.MockAgent">
        function <span class="apidocSignatureSpan">apnagent.</span>MockAgent
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Mock() {
  Base.call(this);

  // Messages sent to these devices will be rejected with error 8 BAD_TOKEN
  this.badDevices = []
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockAgent._super" id="apidoc.element.apnagent.MockAgent._super">
        function <span class="apidocSignatureSpan">apnagent.MockAgent.</span>_super
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Base() {
  EventEmitter.call(this, { delimeter: ':' });
  this.connected = false;

  // default settings
  this.set('cache ttl', '10m');
  this.set('codec', 'enhanced');
  this.set('expires', 0);
  this.enable('reconnect');
  this.set('reconnect delay', 3000);
  this.disable('sandbox');

  // internal storage
  this.meta = {};
  this.meta.lastId = -1;
  this.meta.gatewayError = null;
  this.meta.timer = null;

  var self = this
    , cache, decoder, encoder, queue;

  // temp storage for messages
  cache = new Cache();

  // queue handles writing buffers to gateway
  queue = new Queue(function () {
    debug('(queue) iterate');
    self._queueIterator.apply(self, arguments);
  }, 1);

  // start in paused state
  cache.pause();
  queue.pause();

  // emit queue errors on agent
  queue.onerror = function (err) {
    debug('(queue) error: %s', err.message);
    self.emit('queue:error', err);
  };

  // emit queue drain on agent
  queue.drain = function () {
    debug('(queue) drain');
    self.emit('queue:drain');
  };

  // decoder handles incoming apn errors
  decoder = lotus.createDecoder();
  decoder.stream(8, codecs.getInterface('gateway response', 'decode'));

  // listen for responses
  decoder.stream(8).on('readable', function () {
    var obj = this.read();
    obj.code = obj.code[0];

    var message = notifErrors[obj.code] || 'None (unknown)'
      , err = new errors.GatewayMessageError(message, obj)
      , cached = self.cache.get(obj.identifier)
      , msg = null;

    if (cached) {
      msg = new Message(self, 'enhanced', cached.json.payload);
      msg.device(cached.json.deviceToken);
      msg.meta.expires = cached.json.expiration;
    }

    debug('(message) error: %s', err.message);
    self.meta.gatewayError = err;
    self.emit('message:error', err, msg);
  });

  // encoder handles converting msg json to buffers
  encoder = lotus.createEncoder();
  encoder.stream(0, codecs.getInterface('gateway simple', 'encode'));
  encoder.stream(1, codecs.getInterface('gateway enhanced', 'encode'));

  // mount objects
  this.cache = cache;
  this.decoder = decoder;
  this.encoder = encoder;
  this.gateway = null;
  this.queue = queue;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.MockAgent.prototype" id="apidoc.module.apnagent.MockAgent.prototype">module apnagent.MockAgent.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.MockAgent.prototype._queueIterator" id="apidoc.element.apnagent.MockAgent.prototype._queueIterator">
        function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>_queueIterator
        <span class="apidocSignatureSpan">(obj, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_queueIterator = function (obj, next) {
  var self = this
    , cache = this.cache
    , encoder = this.encoder
    , stream = encoder.stream(obj.codec)
    , id = obj.json.identifier
    , queue = this.queue;

  // wait for encoded message
  encoder.once('readable', function () {
    var buf = encoder.read()
      , gateway = self.gateway;

    // requeue if not connected
    if (!gateway || !gateway.writable || !self.connected) {
      debug('(queue) pause: not connected');
      queue.pause();
      queue.pushAt(0, obj);
      return next();
    }

    debug('(gateway) write: %d', id);
    gateway.write(buf);
    process.nextTick(function () {
      debug('(cache) push: %d', id);
      cache.push(id, obj);
      next();
    });
  });

  // encode message
  debug('(encoder) write: %d', id);
  stream.write(obj.json);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockAgent.prototype.close" id="apidoc.element.apnagent.MockAgent.prototype.close">
        function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>close
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function (cb) {
  cb = cb || function () {};

  // leave if nothing needs to be done
  if (!this.connected || !this.gateway) {
    clearTimeout(this.meta.timer);
    process.nextTick(cb);
    return this;
  }

  var self = this
    , drain = this.queue.drain;

  // wait for queue to finish processing current
  this.queue.drain = function () {
    debug('(gateway) disconnecting');
    self.cache.pause();
    process.nextTick(cb);
    self.gateway.end();
    self.queue.drain = drain;
  };

  // set things in motion
  this.connected = false;
  this.queue.pause();
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1.0.0 / 2013-03-27
==================

* pkg: update description
* docs: update
* feedback: [base] change default interval
* agent: [all] reconnect now cancelled by .<span class="apidocCodeKeywordSpan">close</span>()
* docs: add resources section
* docs: color scheme
* docs: checkpoint - agent docs ready for proofread
* agent: [base] documentation
* agent: [mock/live] fix reference to stored gateway error
* Merge branch 'refactor/node10'
* feedback: [base/mock] convert to new lotus api
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockAgent.prototype.connect" id="apidoc.element.apnagent.MockAgent.prototype.connect">
        function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>connect
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect = function (cb) {
  cb = cb || function () {};

  var self = this
    , delay = this.get('reconnect delay')
    , opts = util.gatewayOptions(this)
    , recon = this.enabled('reconnect')
    , ttl = this.get('cache ttl')
    , gateway;

  // how to perform a reconnect
  function reconnect () {
    var gwe = self.meta.gatewayError
      , pos = 0;

    if (gwe &amp;&amp; 'undefined' !== typeof gwe.identifier) {
      debug('(cache) since: %d', gwe.identifier);
      self.cache.sinceId(gwe.identifier, function (obj, id) {
        debug('(queue) push: %d', id);
        self.queue.pushAt(pos++, obj);
      });
    }

    debug('(gateway) reconnecting');
    self.connect(function (err) {
      if (err) return;
      debug('(gateway) reconnected');
      self.emit('gateway:reconnect');
    });
  }

  // reset state
  this.meta.gatewayError = null;

  // mock gateway parses the outgoing buffers back to json
  gateway = lotus.createDecoder();
  gateway.stream(0, codecs.getInterface('gateway simple', 'decode'));
  gateway.stream(1, codecs.getInterface('gateway enhanced', 'decode'));

  // simulate async connect
  debug('(gateway) connecting - mock');
  process.nextTick(function () {
    debug('(gateway) connected - mock');
    self.connected = true;
    self.cache.ttl = ttl;
    self.cache.resume();
    self.queue.resume();
    self.emit('gateway:connect');
    cb();
  });

  function shouldBeRejected (msgJson) {
    msgDevice = new Device(msgJson.deviceToken);
    reject = false;
    for (var i = 0; i &lt; self.badDevices.length; i++) {
      reject = self.badDevices[i].equal(msgDevice)
    }
    return reject;
  }

  // data event is emitted for each message
  function emitter () {
    var json = this.read();
    if (!json) return;

    // Simulate message error at Apple side
    if (shouldBeRejected(json)) {
      var err = new errors.GatewayMessageError("Invalid token", {code: 8})
      self.meta.gatewayError = err;

      debug('(gateway) incoming message error', err.toJSON(false));
      self.emit('message:error', err, json);
      gateway.end();
    } else {
      debug('(gateway) incoming message', json);
      self.emit('mock:message', json);
    }
  }

  gateway.stream(0).on('readable', emitter);
  gateway.stream(1).on('readable', emitter);

  // an error is emitted when an incoming message is badly formatted
  gateway.on('error', function (err) {
    debug('(gateway) error: %s', err.message || 'Unspecified Error');
    self.emit('gateway:error', err);
  });

  // this is similiar to a socket `close` event
  gateway.on('close', function () {
    self.cache.pause();
    self.queue.pause();
    self.gateway = null;

    if (self.connected &amp;&amp; recon) {
      debug('(gateway) disconnected - mock');
      self.connected = false;
      self.meta.timer = setTimeout(reconnect, ms(delay));
    } else {
      debug('(gateway) closed - mock');
      self.connected = false;
      self.emit('gateway:close');
    }
  });

  // mount
  this.gateway = gateway;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    self.cache.sinceId(gwe.identifier, function (obj, id) {
      debug('(queue) push: %d', id);
      self.queue.pushAt(pos++, obj);
    });
  }

  debug('(gateway) reconnecting');
  self.<span class="apidocCodeKeywordSpan">connect</span>(function (err) {
    if (err) return;
    debug('(gateway) reconnected');
    self.emit('gateway:reconnect');
  });
};

/**
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockAgent.prototype.setBadDevices" id="apidoc.element.apnagent.MockAgent.prototype.setBadDevices">
        function <span class="apidocSignatureSpan">apnagent.MockAgent.prototype.</span>setBadDevices
        <span class="apidocSignatureSpan">(devices)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setBadDevices = function (devices) {
  // Validate input, crash early if smth is wrong -
  // better than search for a bug somewhere deep in code
  if (!(devices instanceof Array)) {
    throw new Error('Parameter "devices" should be an array of Device');
  } else {
    for (var i = 0; i &lt; devices.length; i++) {
      if (!(devices[i] instanceof Device)) {
        throw new Error('Parameter "devices" should be an array of Device')
      }
    }
  }

  // All good
  this.badDevices = devices;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.MockFeedback" id="apidoc.module.apnagent.MockFeedback">module apnagent.MockFeedback</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.MockFeedback.MockFeedback" id="apidoc.element.apnagent.MockFeedback.MockFeedback">
        function <span class="apidocSignatureSpan">apnagent.</span>MockFeedback
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Mock() {
  Base.call(this);
  this.meta.outgoing = [];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockFeedback._super" id="apidoc.element.apnagent.MockFeedback._super">
        function <span class="apidocSignatureSpan">apnagent.MockFeedback.</span>_super
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Base() {
  EventEmitter.call(this, { delimeter: ':' });
  this.connected = false;
  this.set('interval', '30m');
  this.disable('sandbox');

  this.meta = {};
  this.meta.timer = null;
  this.meta.stack = [ emit ];

  var self = this
    , decoder, queue;

  // queue handles user interaction with responses
  queue = new Queue(function (obj, done) {
    var device = obj.device
      , stack = self.meta.stack
      , timestamp = obj.timestamp;

    // intercept errors so as not to cancel queue
    function finish (err) {
      if (err) {
        debug('(iterate) error - %s', err.message);
        self.emit('iterate:error', err, device, timestamp);
      }

      debug('(iterate) end - %s', device.toString());
      done();
    }

    // start iteration
    debug('(iterate) start - %s', device.toString());
    series(stack, function (fn, next) {
      fn.apply(self, [ device, timestamp, next ]);
    }, finish);
  }, 10);

  // emit queue errors on feedback agent
  queue.onerror = function (err) {
    debug('(queue) error: %s', err.message);
    self.emit('queue:error', err);
  };

  // emit queue drain on feedback agent
  queue.drain = function () {
    debug('(queue) drain');
    self.emit('queue:drain');
  };

  // decoder handing incoming feedback responses
  decoder = lotus.createDecoder();
  decoder.stream(codecs.getInterface('feedback response', 'decode'));
  decoder.stream().on('readable', function () {
    var obj = this.read()
      , res = {};
    res.device = new Device(obj.deviceToken);
    res.timestamp = new Date(obj.timestamp * 1000);
    queue.push(res, true);
  });

  this.decoder = decoder;
  this.feedback = null;
  this.queue = queue;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.MockFeedback.prototype" id="apidoc.module.apnagent.MockFeedback.prototype">module apnagent.MockFeedback.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.MockFeedback.prototype.close" id="apidoc.element.apnagent.MockFeedback.prototype.close">
        function <span class="apidocSignatureSpan">apnagent.MockFeedback.prototype.</span>close
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function (cb) {
  cb = cb || function () {};

  // if not connected, cancel reconnect time
  if (!this.connected || !this.feedback) {
    clearTimeout(this.meta.timer);
    process.nextTick(cb);
    return this;
  }

  // wait for feedback to finish download
  this.feedback.once('end', cb);
  this.connected = false;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1.0.0 / 2013-03-27
==================

* pkg: update description
* docs: update
* feedback: [base] change default interval
* agent: [all] reconnect now cancelled by .<span class="apidocCodeKeywordSpan">close</span>()
* docs: add resources section
* docs: color scheme
* docs: checkpoint - agent docs ready for proofread
* agent: [base] documentation
* agent: [mock/live] fix reference to stored gateway error
* Merge branch 'refactor/node10'
* feedback: [base/mock] convert to new lotus api
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockFeedback.prototype.connect" id="apidoc.element.apnagent.MockFeedback.prototype.connect">
        function <span class="apidocSignatureSpan">apnagent.MockFeedback.prototype.</span>connect
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect = function (cb) {
  cb = cb || function () {};

  var self = this
    , interval = this.get('interval')
    , opts = util.feedbackOptions(this)
    , feedback;

  // how to perform a reconnect
  function reconnect () {
    debug('(feedback) reconnecting');
    self.connect(function (err) {
      if (err) return;
      debug('(feedback) reconnected');
      self.emit('feedback:reconnect');
    });
  }

  // mock feedback writes mock unsubs to decoder
  feedback = lotus.createEncoder();
  feedback.stream(codecs.getInterface('feedback response', 'encode'));

  // simulate async connect
  debug('(feedback) connecting - mock');
  process.nextTick(function () {
    debug('(feedback) connected - mock');
    self.connected = true;
    self.emit('feedback:connect');
    cb();

    // send simulated data
    setTimeout(function () {
      var outgoing = self.meta.outgoing
        , stream = feedback.stream()
        , line;

      debug('(mock) simulating [%d] unsubs', outgoing.length);
      while (outgoing.length) {
        line = outgoing.shift();
        debug('(mock) writing unsub - %s', line.deviceToken.toString('hex'));
        stream.write(line);
      }

      debug('(mock) writing complete');
      stream.end();
    }, 10);
  });

  // handle "incoming" data
  feedback.on('data', function (buf) {
    debug('(feedback) data: %d bytes, buf.length');
    self.decoder.write(buf);
  });

  // emit errors;
  feedback.on('error', function (err) {
    debug('(feedback) error: %s', err.message || 'Unspecified Error');
    self.emit('feedback:error', err);
  });

  // end is similiar to a socket `close` event
  feedback.on('end', function () {
    self.feedback = null;

    if (self.connected) {
      debug('(feedback) disconnected - %s:%d', opts.host, opts.port);
      self.connected = false;
      self.meta.timer = setTimeout(reconnect, ms(interval));
    } else {
      debug('(feedback) closed - %s:%d', opts.host, opts.port);
      self.connected = false;
      self.emit('feedback:close');
    }
  });

  // mount
  this.feedback = feedback;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    self.cache.sinceId(gwe.identifier, function (obj, id) {
      debug('(queue) push: %d', id);
      self.queue.pushAt(pos++, obj);
    });
  }

  debug('(gateway) reconnecting');
  self.<span class="apidocCodeKeywordSpan">connect</span>(function (err) {
    if (err) return;
    debug('(gateway) reconnected');
    self.emit('gateway:reconnect');
  });
};

/**
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.MockFeedback.prototype.unsub" id="apidoc.element.apnagent.MockFeedback.prototype.unsub">
        function <span class="apidocSignatureSpan">apnagent.MockFeedback.prototype.</span>unsub
        <span class="apidocSignatureSpan">(token, ts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unsub = function (token, ts) {
  var device = new Device(token)
    , timestamp;

  // figure out time
  if (ts &amp;&amp; 'number' === typeof ts) {
    timestamp = ts;
  } else if (ts &amp;&amp; 'string' === typeof ts) {
    timestamp = ms.unix(ts);
  } else if (ts &amp;&amp; ts instanceof Date) {
    timestamp = ts.getTime() / 1000;
  } else {
    timestamp = ms.unix('-1s');
  }

  // add to outgoing queue
  this.meta.outgoing.push({
      deviceToken: device.toBuffer()
    , timestamp: timestamp
  });

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.apnagent" id="apidoc.module.apnagent.apnagent">module apnagent.apnagent</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.apnagent.Agent" id="apidoc.element.apnagent.apnagent.Agent">
        function <span class="apidocSignatureSpan">apnagent.apnagent.</span>Agent
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Agent() {
  Base.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.apnagent.Device" id="apidoc.element.apnagent.apnagent.Device">
        function <span class="apidocSignatureSpan">apnagent.apnagent.</span>Device
        <span class="apidocSignatureSpan">(token)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Device(token) {
<span class="apidocCodeCommentSpan">  /*!
   * @param {String|Buffer|Device} device token
   * @api public
   */
</span>  if (token instanceof Device) {
    token = token.toString();
  }

  this.token = token || undefined;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.apnagent.Feedback" id="apidoc.element.apnagent.apnagent.Feedback">
        function <span class="apidocSignatureSpan">apnagent.apnagent.</span>Feedback
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Feedback() {
  Base.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.apnagent.MockAgent" id="apidoc.element.apnagent.apnagent.MockAgent">
        function <span class="apidocSignatureSpan">apnagent.apnagent.</span>MockAgent
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Mock() {
  Base.call(this);

  // Messages sent to these devices will be rejected with error 8 BAD_TOKEN
  this.badDevices = []
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.apnagent.MockFeedback" id="apidoc.element.apnagent.apnagent.MockFeedback">
        function <span class="apidocSignatureSpan">apnagent.apnagent.</span>MockFeedback
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Mock() {
  Base.call(this);
  this.meta.outgoing = [];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.cache" id="apidoc.module.apnagent.cache">module apnagent.cache</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.cache.cache" id="apidoc.element.apnagent.cache.cache">
        function <span class="apidocSignatureSpan">apnagent.</span>cache
        <span class="apidocSignatureSpan">(ttl)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Cache(ttl) {
  this.store = [];
  this.timer = null;
  this.ttl = ttl || '10m';
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.cache.prototype" id="apidoc.module.apnagent.cache.prototype">module apnagent.cache.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.cache.prototype.flush" id="apidoc.element.apnagent.cache.prototype.flush">
        function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>flush
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">flush = function () {
  debug('(store) flush');
  this.store = [];
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

Cache.prototype.sinceId = function (id, iterator) {
var pos = -1
  , store = this.store
  , i = 0
  , l;

this.<span class="apidocCodeKeywordSpan">flush</span>();

// find where to start
for (; i &lt; store.length; i++) {
  if (store[i].id === id) {
    pos = i;
    break;
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.cache.prototype.get" id="apidoc.element.apnagent.cache.prototype.get">
        function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>get
        <span class="apidocSignatureSpan">(id)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function (id) {
  var i = 0
    , res = undefined
    , store = this.store;

  for (; i &lt; store.length; i++){
    if (store[i].id === id) {
      res = store[i].obj;
      break;
    }
  }

  return res;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
     this.alert('body', opts.aps.alert);
   } else if (opts.aps.alert) {
     this.alert(opts.aps.alert);
   }
 }

 if (agent &amp;&amp; 'simple' !== codec) {
   this.expires(agent.<span class="apidocCodeKeywordSpan">get</span>('expires'));
 }
}

/**
* ### .alert (key, value)
*
* Sets variables to be included in the `alert` dictionary
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.cache.prototype.pause" id="apidoc.element.apnagent.cache.prototype.pause">
        function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>pause
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">pause = function () {
  debug('(timer) pause')
  clearTimeout(this.timer);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// queue handles writing buffers to gateway
queue = new Queue(function () {
  debug('(queue) iterate');
  self._queueIterator.apply(self, arguments);
}, 1);

// start in paused state
cache.<span class="apidocCodeKeywordSpan">pause</span>();
queue.pause();

// emit queue errors on agent
queue.onerror = function (err) {
  debug('(queue) error: %s', err.message);
  self.emit('queue:error', err);
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.cache.prototype.push" id="apidoc.element.apnagent.cache.prototype.push">
        function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>push
        <span class="apidocSignatureSpan">(id, obj, age)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">push = function (id, obj, age) {
  debug('(store) push: %s', id + '');
  this.store.push({
      age: age || new Date().getTime()
    , id: id
    , obj: obj
  });

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @param {Number} timestamp of object creation
 * @return {this} for chaining
 * @api public
 */

Cache.prototype.push = function (id, obj, age) {
  debug('(store) push: %s', id + '');
  this.store.<span class="apidocCodeKeywordSpan">push</span>({
      age: age || new Date().getTime()
    , id: id
    , obj: obj
  });

  return this;
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.cache.prototype.resume" id="apidoc.element.apnagent.cache.prototype.resume">
        function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>resume
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">resume = function () {
  var self = this
    , ttl = ms(this.ttl);

  // re-add new objects
  function push (obj, id, age) {
    self.push(id, obj, age);
  }

  // get older than and iterate
  function clean () {
    debug('(timer) clean older than %dms', ttl);
    self.sinceTime(new Date().getTime() - ttl, push);
    self.timer = setTimeout(clean, ttl);
  }

  // do first cleaning
  debug('(timer) resume');
  clean();
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// connect to gateway
debug('(gateway) connecting - %s:%d', opts.host, opts.port);
gateway = tls.connect(opts, function () {
  if (gateway.authorized) {
    debug('(gateway) connected - %s:%d', opts.host, opts.port);
    self.connected = true;
    self.cache.ttl = ttl;
    self.cache.<span class="apidocCodeKeywordSpan">resume</span>();
    self.queue.resume();
    self.emit('gateway:connect');
    cb();
  } else {
    var err = new errors.GatewayAuthorizationError(gateway.authorizationError);
    debug('(gateway) unauthorized - %s:%d', opts.host, opts.port, gateway.authorizationError);
    self.gateway.destroy();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.cache.prototype.sinceId" id="apidoc.element.apnagent.cache.prototype.sinceId">
        function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>sinceId
        <span class="apidocSignatureSpan">(id, iterator)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">sinceId = function (id, iterator) {
  var pos = -1
    , store = this.store
    , i = 0
    , l;

  this.flush();

  // find where to start
  for (; i &lt; store.length; i++) {
    if (store[i].id === id) {
      pos = i;
      break;
    }
  }

  // iterate with the rest
  if (pos !== -1) {
    pos++; // we don't want the match
    for (; pos &lt; store.length; pos++) {
      l = store[pos];
      iterator(l.obj, l.id, l.age);
    }
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Agent.prototype._reconnect = function(){
var self = this
  , gwe = self.meta.gatewayError
  , pos = 0;

if (gwe &amp;&amp; 'undefined' !== typeof gwe.identifier) {
  debug('(cache) since: %d', gwe.identifier);
  self.cache.<span class="apidocCodeKeywordSpan">sinceId</span>(gwe.identifier, function (obj, id) {
    debug('(queue) push: %d', id);
    self.queue.pushAt(pos++, obj);
  });
}

debug('(gateway) reconnecting');
self.connect(function (err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.cache.prototype.sinceTime" id="apidoc.element.apnagent.cache.prototype.sinceTime">
        function <span class="apidocSignatureSpan">apnagent.cache.prototype.</span>sinceTime
        <span class="apidocSignatureSpan">(age, iterator)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">sinceTime = function (age, iterator) {
  var store = this.store
    , i = 0
    , l;

  this.flush();

  // iterate for all that match
  for (; i &lt; store.length; i++) {
    l = store[i];
    if (l.age &gt; age) {
      iterator(l.obj, l.id, l.age);
    }
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
function push (obj, id, age) {
  self.push(id, obj, age);
}

// get older than and iterate
function clean () {
  debug('(timer) clean older than %dms', ttl);
  self.<span class="apidocCodeKeywordSpan">sinceTime</span>(new Date().getTime() - ttl, push);
  self.timer = setTimeout(clean, ttl);
}

// do first cleaning
debug('(timer) resume');
clean();
return this;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors" id="apidoc.module.apnagent.errors">module apnagent.errors</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError" id="apidoc.element.apnagent.errors.FeedbackAuthorizationError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>FeedbackAuthorizationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  , interval = this.get('interval')
  , opts = util.feedbackOptions(this)
  , feedback;

// don't try to connect without credentials
if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
  process.nextTick(function () {
    var err = new errors.<span class="apidocCodeKeywordSpan">FeedbackAuthorizationError</span>('Insufficient credentials'
;);
    debug('(feedback) error: %s', err.message);
    self.emit('feedback:error', err);
    cb(err);
  });

  return this;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayAuthorizationError" id="apidoc.element.apnagent.errors.GatewayAuthorizationError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayAuthorizationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  , recon = this.enabled('reconnect')
  , ttl = this.get('cache ttl')
  , gateway;

// don't try to connect without credentials
if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
  process.nextTick(function () {
    var err = new errors.<span class="apidocCodeKeywordSpan">GatewayAuthorizationError</span>('Insufficient credentials'
;);
    debug('(gateway) error: %s', err.message);
    self.emit('gateway:error', err);
    cb(err);
  });

  return this;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayMessageError" id="apidoc.element.apnagent.errors.GatewayMessageError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayMessageError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

  // listen for responses
  decoder.stream(8).on('readable', function () {
var obj = this.read();
obj.code = obj.code[0];

var message = notifErrors[obj.code] || 'None (unknown)'
  , err = new errors.<span class="apidocCodeKeywordSpan">GatewayMessageError</span>(message, obj)
  , cached = self.cache.get(obj.identifier)
  , msg = null;

if (cached) {
  msg = new Message(self, 'enhanced', cached.json.payload);
  msg.device(cached.json.deviceToken);
  msg.meta.expires = cached.json.expiration;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.MessageSerializationError" id="apidoc.element.apnagent.errors.MessageSerializationError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>MessageSerializationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.FeedbackAuthorizationError" id="apidoc.module.apnagent.errors.FeedbackAuthorizationError">module apnagent.errors.FeedbackAuthorizationError</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.FeedbackAuthorizationError" id="apidoc.element.apnagent.errors.FeedbackAuthorizationError.FeedbackAuthorizationError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>FeedbackAuthorizationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  , interval = this.get('interval')
  , opts = util.feedbackOptions(this)
  , feedback;

// don't try to connect without credentials
if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
  process.nextTick(function () {
    var err = new errors.<span class="apidocCodeKeywordSpan">FeedbackAuthorizationError</span>('Insufficient credentials'
;);
    debug('(feedback) error: %s', err.message);
    self.emit('feedback:error', err);
    cb(err);
  });

  return this;
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.FeedbackAuthorizationError.prototype" id="apidoc.module.apnagent.errors.FeedbackAuthorizationError.prototype">module apnagent.errors.FeedbackAuthorizationError.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.constructor" id="apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.constructor">
        function <span class="apidocSignatureSpan">apnagent.errors.FeedbackAuthorizationError.prototype.</span>constructor
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.serialize" id="apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.serialize">
        function <span class="apidocSignatureSpan">apnagent.errors.FeedbackAuthorizationError.prototype.</span>serialize
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">serialize = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!~[ 0, 1 ].indexOf(codec)) {
  error(new errors.SerializationError('Invalid codec: ' + codecStr));
  return this;
}

// serialize the message
try {
  json = msg.<span class="apidocCodeKeywordSpan">serialize</span>();
} catch (ex) {
  error(ex);
  return this;
}

// write json to to the queue
debug('(queue) push: %d', json.identifier);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.toJSON" id="apidoc.element.apnagent.errors.FeedbackAuthorizationError.prototype.toJSON">
        function <span class="apidocSignatureSpan">apnagent.errors.FeedbackAuthorizationError.prototype.</span>toJSON
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (!json) return;

  // Simulate message error at Apple side
  if (shouldBeRejected(json)) {
    var err = new errors.GatewayMessageError("Invalid token", {code: 8})
    self.meta.gatewayError = err;

    debug('(gateway) incoming message error', err.<span class="apidocCodeKeywordSpan">toJSON</span>(false));
    self.emit('message:error', err, json);
    gateway.end();
  } else {
    debug('(gateway) incoming message', json);
    self.emit('mock:message', json);
  }
}
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.GatewayAuthorizationError" id="apidoc.module.apnagent.errors.GatewayAuthorizationError">module apnagent.errors.GatewayAuthorizationError</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.GatewayAuthorizationError" id="apidoc.element.apnagent.errors.GatewayAuthorizationError.GatewayAuthorizationError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayAuthorizationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  , recon = this.enabled('reconnect')
  , ttl = this.get('cache ttl')
  , gateway;

// don't try to connect without credentials
if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
  process.nextTick(function () {
    var err = new errors.<span class="apidocCodeKeywordSpan">GatewayAuthorizationError</span>('Insufficient credentials'
;);
    debug('(gateway) error: %s', err.message);
    self.emit('gateway:error', err);
    cb(err);
  });

  return this;
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.GatewayAuthorizationError.prototype" id="apidoc.module.apnagent.errors.GatewayAuthorizationError.prototype">module apnagent.errors.GatewayAuthorizationError.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.constructor" id="apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.constructor">
        function <span class="apidocSignatureSpan">apnagent.errors.GatewayAuthorizationError.prototype.</span>constructor
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.serialize" id="apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.serialize">
        function <span class="apidocSignatureSpan">apnagent.errors.GatewayAuthorizationError.prototype.</span>serialize
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">serialize = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!~[ 0, 1 ].indexOf(codec)) {
  error(new errors.SerializationError('Invalid codec: ' + codecStr));
  return this;
}

// serialize the message
try {
  json = msg.<span class="apidocCodeKeywordSpan">serialize</span>();
} catch (ex) {
  error(ex);
  return this;
}

// write json to to the queue
debug('(queue) push: %d', json.identifier);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.toJSON" id="apidoc.element.apnagent.errors.GatewayAuthorizationError.prototype.toJSON">
        function <span class="apidocSignatureSpan">apnagent.errors.GatewayAuthorizationError.prototype.</span>toJSON
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (!json) return;

  // Simulate message error at Apple side
  if (shouldBeRejected(json)) {
    var err = new errors.GatewayMessageError("Invalid token", {code: 8})
    self.meta.gatewayError = err;

    debug('(gateway) incoming message error', err.<span class="apidocCodeKeywordSpan">toJSON</span>(false));
    self.emit('message:error', err, json);
    gateway.end();
  } else {
    debug('(gateway) incoming message', json);
    self.emit('mock:message', json);
  }
}
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.GatewayMessageError" id="apidoc.module.apnagent.errors.GatewayMessageError">module apnagent.errors.GatewayMessageError</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayMessageError.GatewayMessageError" id="apidoc.element.apnagent.errors.GatewayMessageError.GatewayMessageError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>GatewayMessageError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

  // listen for responses
  decoder.stream(8).on('readable', function () {
var obj = this.read();
obj.code = obj.code[0];

var message = notifErrors[obj.code] || 'None (unknown)'
  , err = new errors.<span class="apidocCodeKeywordSpan">GatewayMessageError</span>(message, obj)
  , cached = self.cache.get(obj.identifier)
  , msg = null;

if (cached) {
  msg = new Message(self, 'enhanced', cached.json.payload);
  msg.device(cached.json.deviceToken);
  msg.meta.expires = cached.json.expiration;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.GatewayMessageError.prototype" id="apidoc.module.apnagent.errors.GatewayMessageError.prototype">module apnagent.errors.GatewayMessageError.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayMessageError.prototype.constructor" id="apidoc.element.apnagent.errors.GatewayMessageError.prototype.constructor">
        function <span class="apidocSignatureSpan">apnagent.errors.GatewayMessageError.prototype.</span>constructor
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayMessageError.prototype.serialize" id="apidoc.element.apnagent.errors.GatewayMessageError.prototype.serialize">
        function <span class="apidocSignatureSpan">apnagent.errors.GatewayMessageError.prototype.</span>serialize
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">serialize = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!~[ 0, 1 ].indexOf(codec)) {
  error(new errors.SerializationError('Invalid codec: ' + codecStr));
  return this;
}

// serialize the message
try {
  json = msg.<span class="apidocCodeKeywordSpan">serialize</span>();
} catch (ex) {
  error(ex);
  return this;
}

// write json to to the queue
debug('(queue) push: %d', json.identifier);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.GatewayMessageError.prototype.toJSON" id="apidoc.element.apnagent.errors.GatewayMessageError.prototype.toJSON">
        function <span class="apidocSignatureSpan">apnagent.errors.GatewayMessageError.prototype.</span>toJSON
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (!json) return;

  // Simulate message error at Apple side
  if (shouldBeRejected(json)) {
    var err = new errors.GatewayMessageError("Invalid token", {code: 8})
    self.meta.gatewayError = err;

    debug('(gateway) incoming message error', err.<span class="apidocCodeKeywordSpan">toJSON</span>(false));
    self.emit('message:error', err, json);
    gateway.end();
  } else {
    debug('(gateway) incoming message', json);
    self.emit('mock:message', json);
  }
}
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.MessageSerializationError" id="apidoc.module.apnagent.errors.MessageSerializationError">module apnagent.errors.MessageSerializationError</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.MessageSerializationError.MessageSerializationError" id="apidoc.element.apnagent.errors.MessageSerializationError.MessageSerializationError">
        function <span class="apidocSignatureSpan">apnagent.errors.</span>MessageSerializationError
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.errors.MessageSerializationError.prototype" id="apidoc.module.apnagent.errors.MessageSerializationError.prototype">module apnagent.errors.MessageSerializationError.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.errors.MessageSerializationError.prototype.constructor" id="apidoc.element.apnagent.errors.MessageSerializationError.prototype.constructor">
        function <span class="apidocSignatureSpan">apnagent.errors.MessageSerializationError.prototype.</span>constructor
        <span class="apidocSignatureSpan">(message, props, ssf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ErrorProto(message, props, ssf) {
  var exclude = extend.exclude('name', 'message', 'stack')
    , props = exclude(props || {});

  this.message = message || ('Unspecified ' + name);
  extend(this, props);

  ssf = ssf || arguments.callee;
  if (ssf &amp;&amp; Error.captureStackTrace) {
    Error.captureStackTrace(this, ssf);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.MessageSerializationError.prototype.serialize" id="apidoc.element.apnagent.errors.MessageSerializationError.prototype.serialize">
        function <span class="apidocSignatureSpan">apnagent.errors.MessageSerializationError.prototype.</span>serialize
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">serialize = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!~[ 0, 1 ].indexOf(codec)) {
  error(new errors.SerializationError('Invalid codec: ' + codecStr));
  return this;
}

// serialize the message
try {
  json = msg.<span class="apidocCodeKeywordSpan">serialize</span>();
} catch (ex) {
  error(ex);
  return this;
}

// write json to to the queue
debug('(queue) push: %d', json.identifier);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.errors.MessageSerializationError.prototype.toJSON" id="apidoc.element.apnagent.errors.MessageSerializationError.prototype.toJSON">
        function <span class="apidocSignatureSpan">apnagent.errors.MessageSerializationError.prototype.</span>toJSON
        <span class="apidocSignatureSpan">(stack)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function (stack) {
  var exclude = extend.exclude('constructor', 'serialize', 'toJSON', 'stack')
    , props = exclude({ name: this.name }, this);

  if (false !== stack &amp;&amp; this.stack) {
    props.stack = this.stack;
  }

  return props;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (!json) return;

  // Simulate message error at Apple side
  if (shouldBeRejected(json)) {
    var err = new errors.GatewayMessageError("Invalid token", {code: 8})
    self.meta.gatewayError = err;

    debug('(gateway) incoming message error', err.<span class="apidocCodeKeywordSpan">toJSON</span>(false));
    self.emit('message:error', err, json);
    gateway.end();
  } else {
    debug('(gateway) incoming message', json);
    self.emit('mock:message', json);
  }
}
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.index" id="apidoc.module.apnagent.index">module apnagent.index</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.index.getId" id="apidoc.element.apnagent.index.getId">
        function <span class="apidocSignatureSpan">apnagent.index.</span>getId
        <span class="apidocSignatureSpan">(name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getId = function (name) {
  var codec = codecs.filter(function (codec) {
    return name === codec.name;
  })[0];

  return codec
    ? codec.id
    : undefined;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */

Base.prototype.send = function (msg, cb) {
cb = cb || function () {};

var self = this
  , codecStr = msg.meta.codec
  , codec = codecs.<span class="apidocCodeKeywordSpan">getId</span>('gateway ' + codecStr)
  , json;

// handle error
function error (err) {
  process.nextTick(function () {
    debug('(message) error: %s', err.message);
    cb(err);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.index.getInterface" id="apidoc.element.apnagent.index.getInterface">
        function <span class="apidocSignatureSpan">apnagent.index.</span>getInterface
        <span class="apidocSignatureSpan">(name, interface)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getInterface = function (name, interface) {
  var codec = codecs.filter(function (codec) {
    return name === codec.name;
  })[0];

  return codec
    ? codec.mod[interface]
    : undefined;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  queue.drain = function () {
debug('(queue) drain');
self.emit('queue:drain');
  };

  // decoder handles incoming apn errors
  decoder = lotus.createDecoder();
  decoder.stream(8, codecs.<span class="apidocCodeKeywordSpan">getInterface</span>('gateway response', 'decode'
;));

  // listen for responses
  decoder.stream(8).on('readable', function () {
var obj = this.read();
obj.code = obj.code[0];

var message = notifErrors[obj.code] || 'None (unknown)'
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.message" id="apidoc.module.apnagent.message">module apnagent.message</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.message.message" id="apidoc.element.apnagent.message.message">
        function <span class="apidocSignatureSpan">apnagent.</span>message
        <span class="apidocSignatureSpan">(agent, codec, opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Message(agent, codec, opts) {
<span class="apidocCodeCommentSpan">  /*!
   * @param {Agent} agent to use for sending
   * @param {String} default codec
   * @param {Object} payload to import
   * @api public
   */
</span>
  this._agent = agent;
  this.encoding = 'utf8';

  this.meta = {};
  this.meta.codec = codec;
  this.meta.device = new Device();
  this.meta.expires = null;

  this.settings = {};
  this.payload = {};
  this.aps = {};

  opts = opts || {};

  // import custom encoding
  if (opts.enc) this.encoding = opts.enc;

  // import custom variables
  for (var name in opts) {
    if (name === 'aps' || name === 'enc') continue;
    this.set(name, opts[name]);
  }

  if (opts.aps) {
    // import badge/sound
    if (opts.aps.badge) this.badge(opts.aps.badge);
    if (opts.aps.sound) this.sound(opts.aps.sound);
    if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);

    // import alert
    if (opts.aps.alert &amp;&amp; 'string' === typeof opts.aps.alert) {
      this.alert('body', opts.aps.alert);
    } else if (opts.aps.alert) {
      this.alert(opts.aps.alert);
    }
  }

  if (agent &amp;&amp; 'simple' !== codec) {
    this.expires(agent.get('expires'));
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.message.prototype" id="apidoc.module.apnagent.message.prototype">module apnagent.message.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.alert" id="apidoc.element.apnagent.message.prototype.alert">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>alert
        <span class="apidocSignatureSpan">(key, value)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">alert = function (key, value) {
  var allowed = [
      'body'
    , 'action-loc-key'
    , 'loc-key'
    , 'loc-args'
    , 'launch-image'
  ];

  if ('object' === typeof key) {
    for (var name in key) {
      this.alert(name, key[name]);
    }
  } else if (arguments.length === 1) {
    this.aps['body'] = key;
  } else {
    if (!~allowed.indexOf(key)) return this;
    this.aps[key] = value;
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  // import badge/sound
  if (opts.aps.badge) this.badge(opts.aps.badge);
  if (opts.aps.sound) this.sound(opts.aps.sound);
  if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);

  // import alert
  if (opts.aps.alert &amp;&amp; 'string' === typeof opts.aps.alert) {
    this.<span class="apidocCodeKeywordSpan">alert</span>('body', opts.aps.alert);
  } else if (opts.aps.alert) {
    this.alert(opts.aps.alert);
  }
}

if (agent &amp;&amp; 'simple' !== codec) {
  this.expires(agent.get('expires'));
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.badge" id="apidoc.element.apnagent.message.prototype.badge">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>badge
        <span class="apidocSignatureSpan">(n)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">badge = function (n) {
  this.settings.badge = n;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  for (var name in opts) {
if (name === 'aps' || name === 'enc') continue;
this.set(name, opts[name]);
  }

  if (opts.aps) {
// import badge/sound
if (opts.aps.badge) this.<span class="apidocCodeKeywordSpan">badge</span>(opts.aps.badge);
if (opts.aps.sound) this.sound(opts.aps.sound);
if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);

// import alert
if (opts.aps.alert &amp;&amp; 'string' === typeof opts.aps.alert) {
  this.alert('body', opts.aps.alert);
} else if (opts.aps.alert) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.contentAvailable" id="apidoc.element.apnagent.message.prototype.contentAvailable">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>contentAvailable
        <span class="apidocSignatureSpan">(contentAvailable)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">contentAvailable = function (contentAvailable) {
  if (contentAvailable) {
    this.settings['content-available'] = 1;
  } else {
    this.settings['content-available'] = undefined;
  }
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
this.set(name, opts[name]);
  }

  if (opts.aps) {
// import badge/sound
if (opts.aps.badge) this.badge(opts.aps.badge);
if (opts.aps.sound) this.sound(opts.aps.sound);
if (opts.aps['content-available']) this.<span class="apidocCodeKeywordSpan">contentAvailable</span>(opts.aps['content
-available']);

// import alert
if (opts.aps.alert &amp;&amp; 'string' === typeof opts.aps.alert) {
  this.alert('body', opts.aps.alert);
} else if (opts.aps.alert) {
  this.alert(opts.aps.alert);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.device" id="apidoc.element.apnagent.message.prototype.device">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>device
        <span class="apidocSignatureSpan">(device)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">device = function (device) {
  if (!arguments.length) {
    return this.meta.device;
  } else if (device instanceof Device) {
    this.meta.device = device;
  } else {
    this.meta.device.token = device;
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
*
* Set the device that this message is to be delivered
* to. Device can be provided as a string or buffer. If
* provided as a string, it will be sanitized of spaces
* and extra characters (such as `&lt;` and `&gt;`).
*
* ```js
* msg.<span class="apidocCodeKeywordSpan">device</span>('a1b2c3');
* msg.device('&lt;a1b2c3&gt;');
* ```
*
* @param {apnagent.Device|String|Buffer} device token
* @returns {this} for chaining
* @api public
* @name device
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.expires" id="apidoc.element.apnagent.message.prototype.expires">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>expires
        <span class="apidocSignatureSpan">(time)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">expires = function (time) {
  if ('number' === typeof time) {
    this.meta.expires = time === 0 ? time : ms.unix(time);
    this.meta.codec = 'enhanced';
  } else if (true === time) {
    this.meta.expires = 0;
    this.meta.codec = 'enhanced';
  } else if (!time) {
    this.meta.expires = null;
    this.meta.codec = 'simple'
  } else {
    this.meta.expires = ms.unix(time);
    this.meta.codec = 'enhanced';
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
     this.alert('body', opts.aps.alert);
   } else if (opts.aps.alert) {
     this.alert(opts.aps.alert);
   }
 }

 if (agent &amp;&amp; 'simple' !== codec) {
   this.<span class="apidocCodeKeywordSpan">expires</span>(agent.get('expires'));
 }
}

/**
* ### .alert (key, value)
*
* Sets variables to be included in the `alert` dictionary
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.send" id="apidoc.element.apnagent.message.prototype.send">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>send
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">send = function (cb) {
  cb = cb || function () {};
  if (!this._agent) return cb(new Error('Agent not associated with message.'));
  this._agent.send(this, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
* deps: update with tea-inherits
* agent: [old] remove single class agent

0.2.0 / 2013-01-15
==================

* docs: update readme and package contribs
* message: [send] pseudo-alias to msg._agent.<span class="apidocCodeKeywordSpan">send</span>(this, cb)
* Merge branch 'feature/reconnect'
* test: [agent] should be able to reconnect
* agent: [connect] support for reconnnect
* Merge branch 'feature/events'
* agent: events, custom errors, and improved codec lookup
* errors: add custom errors and expose via exports.errors
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.serialize" id="apidoc.element.apnagent.message.prototype.serialize">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>serialize
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">serialize = function () {
  var codec = this.meta.codec
    , enc = this.encoding
    , payload = {}
    , SE = errors.MessageSerializationError
    , ssf = arguments.callee;

  // check for device
  if (!this.meta.device.toBuffer()) {
    throw new SE('Message device not specified.', null, ssf);
  }

  // enhanced codec requires expiration
  if ('enhanced' === codec &amp;&amp; null === this.meta.expires) {
    throw new SE('Message expiration not specified for enhanced codec delivery.', null, ssf);
  }

  // enchanced code requires agent to generate an id
  if ('enhanced' === codec &amp;&amp; !this._agent) {
    throw new SE('Message agent not specified for enhanced codec delivery.', null, ssf);
  }

  // copy over extra variables
  extend(payload, this.payload);

  // set encoding if not utf8
  if (enc !== 'utf8') {
    payload.enc = this.encoding;
  }

  // copy over badge and sound settings
  payload.aps = {};
  extend(payload.aps, this.settings);

  // copy over alert settings
  var apsLength = Object.keys(this.aps).length;
  if (apsLength === 1 &amp;&amp; this.aps.body) {
    payload.aps.alert = this.aps.body;
  } else if (apsLength &gt; 0) {
    payload.aps.alert = {};
    extend(payload.aps.alert, this.aps);
  }

  // check to ensure body is not to long, shorten if possible
  var str = JSON.stringify(payload)
    , len = Buffer.byteLength(str, enc);

  if (len &gt; MAX_PAYLOAD_SIZE &amp;&amp; this.aps.body) {
    var over = len - MAX_PAYLOAD_SIZE
      , bodyLen = Buffer.byteLength(this.aps.body, enc)
      , body = bodyLen &lt;= over
        ? null
        : util.trim(this.aps.body, bodyLen - over);

    if (!body) {
      throw new SE('Message too long.', null, ssf);
    }

    if ('string' === typeof payload.aps.alert) {
      payload.aps.alert = body;
    } else {
      payload.aps.alert.body = body;
    }
  } else if (len &gt; MAX_PAYLOAD_SIZE) {
    throw new SE('Message too long.', null, ssf);
  }

  // construct the response
  var res = {};
  res.deviceToken = this.meta.device.toBuffer();
  res.expiration = this.meta.expires
  res.identifier = this._agent
    ? this._agent.nextId()
    : null;
  res.payload = payload;
  return res;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!~[ 0, 1 ].indexOf(codec)) {
  error(new errors.SerializationError('Invalid codec: ' + codecStr));
  return this;
}

// serialize the message
try {
  json = msg.<span class="apidocCodeKeywordSpan">serialize</span>();
} catch (ex) {
  error(ex);
  return this;
}

// write json to to the queue
debug('(queue) push: %d', json.identifier);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.set" id="apidoc.element.apnagent.message.prototype.set">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>set
        <span class="apidocSignatureSpan">(key, value)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">set = function (key, value) {
  if ('object' === typeof key) {
    for (var name in key) {
      this.set(name, key[name]);
    }
  } else {
    if (key === 'aps') return;
    this.payload[key] = value;
  }

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// import custom encoding
if (opts.enc) this.encoding = opts.enc;

// import custom variables
for (var name in opts) {
  if (name === 'aps' || name === 'enc') continue;
  this.<span class="apidocCodeKeywordSpan">set</span>(name, opts[name]);
}

if (opts.aps) {
  // import badge/sound
  if (opts.aps.badge) this.badge(opts.aps.badge);
  if (opts.aps.sound) this.sound(opts.aps.sound);
  if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.message.prototype.sound" id="apidoc.element.apnagent.message.prototype.sound">
        function <span class="apidocSignatureSpan">apnagent.message.prototype.</span>sound
        <span class="apidocSignatureSpan">(sound)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">sound = function (sound) {
  this.settings.sound = sound;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (name === 'aps' || name === 'enc') continue;
this.set(name, opts[name]);
  }

  if (opts.aps) {
// import badge/sound
if (opts.aps.badge) this.badge(opts.aps.badge);
if (opts.aps.sound) this.<span class="apidocCodeKeywordSpan">sound</span>(opts.aps.sound);
if (opts.aps['content-available']) this.contentAvailable(opts.aps['content-available']);

// import alert
if (opts.aps.alert &amp;&amp; 'string' === typeof opts.aps.alert) {
  this.alert('body', opts.aps.alert);
} else if (opts.aps.alert) {
  this.alert(opts.aps.alert);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.apnagent.util" id="apidoc.module.apnagent.util">module apnagent.util</a></h1>


    <h2>
        <a href="#apidoc.element.apnagent.util.feedbackOptions" id="apidoc.element.apnagent.util.feedbackOptions">
        function <span class="apidocSignatureSpan">apnagent.util.</span>feedbackOptions
        <span class="apidocSignatureSpan">(agent)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">feedbackOptions = function (agent) {
  var opts = {};

  // get the tls host based on sandbox
  opts.host = agent.enabled('sandbox')
    ? FEED_SANDBOX
    : FEED_PROD;

  // use default port
  opts.port = FEED_PORT;

  // pull in tls options
  exports.tlsOptions(agent, opts);

  return opts;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
inherits(Feedback, Base);

Feedback.prototype.connect = function (cb) {
cb = cb || function () {};

var self = this
  , interval = this.get('interval')
  , opts = util.<span class="apidocCodeKeywordSpan">feedbackOptions</span>(this)
  , feedback;

// don't try to connect without credentials
if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
  process.nextTick(function () {
    var err = new errors.FeedbackAuthorizationError('Insufficient credentials');
    debug('(feedback) error: %s', err.message);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.util.gatewayOptions" id="apidoc.element.apnagent.util.gatewayOptions">
        function <span class="apidocSignatureSpan">apnagent.util.</span>gatewayOptions
        <span class="apidocSignatureSpan">(agent)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">gatewayOptions = function (agent) {
  var opts = {};

  // get the tls host based on sandbox
  opts.host = agent.enabled('sandbox')
    ? APNS_SANDBOX
    : APNS_PROD;

  // use default port
  opts.port = APNS_PORT;

  // pull in tls options
  exports.tlsOptions(agent, opts);

  return opts;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @api public
 */
Agent.prototype.connect = function (cb) {
cb = cb || function () {};

var self = this
  , delay = this.get('reconnect delay')
  , opts = util.<span class="apidocCodeKeywordSpan">gatewayOptions</span>(this)
  , recon = this.enabled('reconnect')
  , ttl = this.get('cache ttl')
  , gateway;

// don't try to connect without credentials
if (!opts.pfx &amp;&amp; !opts.key &amp;&amp; !opts.cert) {
  process.nextTick(function () {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.util.tlsOptions" id="apidoc.element.apnagent.util.tlsOptions">
        function <span class="apidocSignatureSpan">apnagent.util.</span>tlsOptions
        <span class="apidocSignatureSpan">(agent, opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">tlsOptions = function (agent, opts) {
  opts = opts || {};

  function copy (key) {
    if (agent.get(key)) opts[key] = agent.get(key);
  }

  function read (file) {
    if (!fs.existsSync(file)) return null;
    return fs.readFileSync(file);
  }

  // get our tls certificates
  if (agent.get('pfx') || agent.get('pfx file')) {
    opts.pfx = agent.get('pfx file')
      ? read(agent.get('pfx file'))
      : agent.get('pfx');
  } else {
    opts.key = agent.get('key file')
      ? read(agent.get('key file'))
      : agent.get('key');
    opts.cert = agent.get('cert file')
      ? read(agent.get('cert file'))
      : agent.get('cert');
  }

  // apply ca certificate
  if (agent.get('ca')) {
    copy('ca');
    opts.ca = [ opts.ca ];
  }

  // include passphrase
  copy('passphrase');

  return opts;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  ? APNS_SANDBOX
  : APNS_PROD;

// use default port
opts.port = APNS_PORT;

// pull in tls options
exports.<span class="apidocCodeKeywordSpan">tlsOptions</span>(agent, opts);

return opts;
};

exports.feedbackOptions = function (agent) {
var opts = {};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.apnagent.util.trim" id="apidoc.element.apnagent.util.trim">
        function <span class="apidocSignatureSpan">apnagent.util.</span>trim
        <span class="apidocSignatureSpan">(str, len)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">trim = function (str, len) {
  var origLen = Buffer.byteLength(str)
    , expLen = len - 3
    , words = str.split(' ')
    , res = words.shift();

  while (Buffer.byteLength(res + words[0]) &lt; expLen - 2) {
    res += ' ' + words.shift();
  }
  return res + '...';
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
, len = Buffer.byteLength(str, enc);

  if (len &gt; MAX_PAYLOAD_SIZE &amp;&amp; this.aps.body) {
var over = len - MAX_PAYLOAD_SIZE
  , bodyLen = Buffer.byteLength(this.aps.body, enc)
  , body = bodyLen &lt;= over
    ? null
    : util.<span class="apidocCodeKeywordSpan">trim</span>(this.aps.body, bodyLen - over);

if (!body) {
  throw new SE('Message too long.', null, ssf);
}

if ('string' === typeof payload.aps.alert) {
  payload.aps.alert = body;
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>